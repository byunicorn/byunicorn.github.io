<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>jQuery Source Code Study 1 - Basic Structure | byunicorn&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Recently I took an online course called “jQuery Source Code Analysis“ which gave a brief introduction for jQuery source code. Since the length of course is limited, the instructor cannot explain every">
<meta property="og:type" content="article">
<meta property="og:title" content="jQuery Source Code Study 1 - Basic Structure">
<meta property="og:url" content="http://unicorn-42.com/2014/11/25/jQuery Source Code Study 1 - Basic Structure/index.html">
<meta property="og:site_name" content="byunicorn's blog">
<meta property="og:description" content="Recently I took an online course called “jQuery Source Code Analysis“ which gave a brief introduction for jQuery source code. Since the length of course is limited, the instructor cannot explain every">
<meta property="og:updated_time" content="2015-01-14T15:25:27.839Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="jQuery Source Code Study 1 - Basic Structure">
<meta name="twitter:description" content="Recently I took an online course called “jQuery Source Code Analysis“ which gave a brief introduction for jQuery source code. Since the length of course is limited, the instructor cannot explain every">
  
    <link rel="alternative" href="/atom.xml" title="byunicorn&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">byunicorn&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://unicorn-42.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-jQuery Source Code Study 1 - Basic Structure" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/11/25/jQuery Source Code Study 1 - Basic Structure/" class="article-date">
  <time datetime="2014-11-25T15:01:55.000Z" itemprop="datePublished">2014-11-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      jQuery Source Code Study 1 - Basic Structure
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Recently I took an online course called “<a href="http://www.imooc.com/view/172?utm_source=jobboleweibo" target="_blank" rel="external">jQuery Source Code Analysis</a>“ which gave a brief introduction for jQuery source code. Since the length of course is limited, the instructor cannot explain every knowledge point in detail.<br>Here I would like to go through the source code and explain the knowledge points in a more intensive manner.<br>You can clone the <a href="https://github.com/jquery/jquery" target="_blank" rel="external">jQuery project</a> from Github, the source codes in <code>src</code> directory are separated in different modules, and it’s easier to understand module one by one than read the whole source code directly. </p>
<p>Since this is the first post, I will introduce the entry of jQuery, including <code>intro.js</code>, <code>outro.js</code> and <code>core/init.js</code>.</p>
<p>p.s.  The chapters with <code>*</code> are further readings.<br><a id="more"></a></p>
<h3 id="Basic_Structure"><a href="#Basic_Structure" class="headerlink" title="Basic Structure"></a>Basic Structure</h3><p>If we look into the <code>Gruntfile.js</code>, we will find that jQuery specific tasks are defined in <code>build/tasks</code>.  The <code>intro.js</code> and <code>outro.js</code> are configured as <code>wrap</code> in file <code>build/tasks/build.js</code>.<br>If you read the built source code, you will find that<code>intro.js</code> and <code>outro.js</code> sandwiched the whole jQuery factory.<br>Combine these two js files, you will get an IIFE structure. IIFE is a kind of function expression.<br>So before we learn IIFE, let’s have a look at Function Expression first.</p>
<h4 id="Function_Declaration_and_Function_Expression"><a href="#Function_Declaration_and_Function_Expression" class="headerlink" title="Function Declaration and Function Expression"></a>Function Declaration and Function Expression</h4><p>There are two ways to define a function: <strong>function declaration</strong> and <strong>function expression</strong><a href="http://www.libuchao.com/2012/06/25/function-declaration-vs-function-expression" target="_blank" rel="external">[1]</a>.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// function declaration</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// function expression</span></span><br><span class="line"><span class="keyword">var</span> foo = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;;</span><br></pre></td></tr></table></figure></p>
<p>And there is a little difference between these two.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">alert(foo);             <span class="comment">// function foo() &#123;&#125;</span></span><br><span class="line">alert(bar);             <span class="comment">// undefined</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;&#125;       <span class="comment">// function declaration</span></span><br><span class="line"><span class="keyword">var</span> bar = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;; <span class="comment">// function expression</span></span><br><span class="line">alert(foo);             <span class="comment">// function foo() &#123;&#125;</span></span><br><span class="line">alert(bar);             <span class="comment">// function() &#123;&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>This diff is caused by hoisting. </p>
<p><strong>Hoisting</strong><a href="http://www.w3schools.com/js/js_hoisting.asp" target="_blank" rel="external">[2]</a> is JavaScript’s default behavior of moving all declarations to the top of the current scope (to the top of the current script or the current function).<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// because of hoisting, a variable can be declared after it has been used</span></span><br><span class="line">x = <span class="number">5</span>; <span class="comment">// Assign 5 to x</span></span><br><span class="line"><span class="keyword">var</span> x; <span class="comment">// Declare x</span></span><br></pre></td></tr></table></figure></p>
<p>Need to notice, JavaScript only hoists declaration, not initialization. The code below is the evidence.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">5</span>; <span class="comment">// Initialize x</span></span><br><span class="line">elem = <span class="built_in">document</span>.getElementById(<span class="string">"demo"</span>); <span class="comment">// Find an element </span></span><br><span class="line"><span class="comment">// only hoists declaration, not initialization</span></span><br><span class="line">elem.innerHTML = x + <span class="string">" "</span> + y;           <span class="comment">// display "5 undefined"</span></span><br><span class="line"><span class="keyword">var</span> y = <span class="number">7</span>; <span class="comment">// Initialize y</span></span><br></pre></td></tr></table></figure></p>
<p>OK, now let’s go back to the difference mentioned before.<br>Both of them are hoisted to the top of the scope. But for declaration, its definition is  loaded before any code is executed, while expression is loaded only when the interpreter reaches that line of code (only hoists declaration, not initialization).</p>
<h4 id="Immediately-Invoked_Function_Expression__28IIFE_29"><a href="#Immediately-Invoked_Function_Expression__28IIFE_29" class="headerlink" title="Immediately-Invoked Function Expression (IIFE)"></a>Immediately-Invoked Function Expression (IIFE)</h4><p>Simply put, <a href="http://stackoverflow.com/questions/8228281/what-is-the-function-construct-in-javascript" target="_blank" rel="external">IIFE</a> is equal to execute an anonymous function right after it’s created.<br>There are three common writing methods of IIFE.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;)();</span><br><span class="line"><span class="comment">// jQuery uses this one</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;());</span><br><span class="line">!<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;();</span><br></pre></td></tr></table></figure></p>
<p>After combining <code>intro.js</code> and <code>outro.js</code>, I remove the inner content. The code is an IIFE structure :<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"> global, factory </span>) </span>&#123;</span><br><span class="line">	<span class="comment">// export the factory to global</span></span><br><span class="line">&#125;(<span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">"undefined"</span> ? <span class="built_in">window</span> : <span class="keyword">this</span>, <span class="function"><span class="keyword">function</span>(<span class="params"> window, noGlobal </span>) </span>&#123;</span><br><span class="line">	<span class="comment">// jQuery factory</span></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure></p>
<p>The code below does the same work the IIFE above did.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// define a function expression</span></span><br><span class="line"><span class="keyword">var</span> bula = <span class="function"><span class="keyword">function</span>(<span class="params"> global, factory </span>) </span>&#123;</span><br><span class="line">	<span class="comment">// export the factory to global</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// call it right after definition</span></span><br><span class="line">bula(<span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">"undefined"</span> ? <span class="built_in">window</span> : <span class="keyword">this</span>, <span class="function"><span class="keyword">function</span>(<span class="params"> window, noGlobal </span>) </span>&#123;</span><br><span class="line">	<span class="comment">// jQuery factory</span></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure></p>
<h4 id="Export_To_Global"><a href="#Export_To_Global" class="headerlink" title="Export To Global"></a>Export To Global</h4><p>Next, let’s have a look at the export part, here the comment from jQuery is clear enough. If you aren’t familiar with CommonJS, you can simply read the next chapter.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// export the factory to global</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params"> global, factory </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( <span class="keyword">typeof</span> <span class="built_in">module</span> === <span class="string">"object"</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">module</span>.exports === <span class="string">"object"</span> ) &#123;</span><br><span class="line">		<span class="comment">// For CommonJS and CommonJS-like environments where a proper window is present,</span></span><br><span class="line">		<span class="comment">// execute the factory and get jQuery</span></span><br><span class="line">		<span class="comment">// For environments that do not inherently posses a window with a document</span></span><br><span class="line">		<span class="comment">// (such as Node.js), expose a jQuery-making factory as module.exports</span></span><br><span class="line">		<span class="comment">// This accentuates the need for the creation of a real window</span></span><br><span class="line">		<span class="comment">// e.g. var jQuery = require("jquery")(window);</span></span><br><span class="line">		<span class="comment">// See ticket #14549 for more info</span></span><br><span class="line">		<span class="built_in">module</span>.exports = global.document ?</span><br><span class="line">			factory( global, <span class="literal">true</span> ) :</span><br><span class="line">			<span class="function"><span class="keyword">function</span>(<span class="params"> w </span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> ( !w.document ) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>( <span class="string">"jQuery requires a window with a document"</span> );</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> factory( w );</span><br><span class="line">			&#125;;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		factory( global );</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="CommonJS_and_AMD*"><a href="#CommonJS_and_AMD*" class="headerlink" title="CommonJS and AMD*"></a>CommonJS and AMD*</h4><p>Let’s talk a little more about <strong>CommonJS and AMD</strong><a href="http://stackoverflow.com/questions/16521471/relation-between-commonjs-amd-and-requirejs" target="_blank" rel="external">[3]</a>.<br>CommonJS is a module specification for server side, <a href="http://nodejs.org/" target="_blank" rel="external">node.js</a> is using this spec.<br>Meanwhile AMD is for browser side, since it supports asynchronous loading of module dependencies, <a href="http://requirejs.org/" target="_blank" rel="external">RequireJS</a> implements AMD.<br>Below are two examples of using CommonJS and AMD</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CommonJS</span></span><br><span class="line"><span class="comment">// assume A.js and B.js are in the same directory</span></span><br><span class="line"><span class="comment">// A.js</span></span><br><span class="line"><span class="built_in">module</span>.export = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="comment">/* ... */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// B.js</span></span><br><span class="line"><span class="keyword">var</span> A = <span class="built_in">require</span>(<span class="string">"./A"</span>);</span><br><span class="line"><span class="built_in">module</span>.export = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="comment">// A.bulabula</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AMD</span></span><br><span class="line">define(<span class="string">'module/id/string'</span>, [<span class="string">'module'</span>, <span class="string">'dependency'</span>, <span class="string">'array'</span>], </span><br><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">module, factory function</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> ModuleContents;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="jQuery_and_jQuery-fn"><a href="#jQuery_and_jQuery-fn" class="headerlink" title="jQuery and jQuery.fn"></a>jQuery and jQuery.fn</h3><h4 id="Static_and_Instance_Functions"><a href="#Static_and_Instance_Functions" class="headerlink" title="Static and Instance Functions"></a>Static and Instance Functions</h4><p>There are two genres of functions in jQuery : static functions and instance functions. <code>jQuery</code>(<code>$</code>) holds the static one and <code>jQuery.fn</code>(<code>$.fn</code>) keeps the instance one.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// static function</span></span><br><span class="line">$.each(<span class="comment">/* ... */</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// instance function</span></span><br><span class="line">$(<span class="string">".div"</span>).each(<span class="comment">/* ... */</span>);</span><br></pre></td></tr></table></figure></p>
<p>Actually the instance function is using the static function.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// static function definition</span></span><br><span class="line">jQuery.extend(&#123;</span><br><span class="line">	each: <span class="function"><span class="keyword">function</span>(<span class="params"> obj, callback, args </span>) </span>&#123;</span><br><span class="line">		<span class="comment">/* ... */</span></span><br><span class="line">	&#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">jQuery.fn = jQuery.prototype = &#123;</span><br><span class="line">	constructor: jQuery</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// using the static each function</span></span><br><span class="line">jQuery.prototype = &#123;</span><br><span class="line">    each: <span class="function"><span class="keyword">function</span>(<span class="params"> callback, args </span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jQuery.each( <span class="keyword">this</span>, callback, args );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>Before we dive into the constructor of jQuery object, we need know some basic things.</p>
<h4 id="What_Happened_When_Call_new_foo_28_29"><a href="#What_Happened_When_Call_new_foo_28_29" class="headerlink" title="What Happened When Call new foo()"></a>What Happened When Call new foo()</h4><ol>
<li>A fresh, blank object is instantiated</li>
<li>The fresh object’s internal prototype <code>__proto__</code> is set to <code>foo.prototype</code>. </li>
<li>The constructor function <code>foo</code> (not necessarily <code>foo.prototype.constructor</code>, see Constructor Property chapter) is called with the specified arguments and this bound to the newly created object.</li>
<li>The object returned by the constructor function becomes the result of the whole new expression. If the constructor function doesn’t explicitly return an object, the object created in step 1 is used instead.</li>
</ol>
<p>p.s. <code>__proto__</code> is the actual object that is used in the lookup chain to resolve methods, etc. prototype is the object that is used to build <code>__proto__</code> when you create an object with new<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Foo</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">( <span class="keyword">new</span> Foo() ).__proto__ === Foo.prototype</span><br><span class="line">( <span class="keyword">new</span> Foo() ).prototype === <span class="literal">undefined</span></span><br></pre></td></tr></table></figure></p>
<h4 id="Constructor_Property"><a href="#Constructor_Property" class="headerlink" title="Constructor Property"></a>Constructor Property</h4><p>In the code piece before, there is a fragment:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jQuery.fn = jQuery.prototype = &#123;</span><br><span class="line">	constructor: jQuery</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><code>jQuery.prototype.constructor</code> is assigned as <code>jQuery</code>. So What’s is this property for ?</p>
<p>The constructor property makes actually no practical difference to anything internally. It’s only any use if your code explicitly uses it.<br>We can have a test on this property:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="function"><span class="keyword">function</span> <span class="title">C</span>(<span class="params"></span>)</span>&#123; <span class="built_in">console</span>.log(<span class="string">"C"</span>); &#125;;</span><br><span class="line">&gt; <span class="function"><span class="keyword">function</span> <span class="title">D</span>(<span class="params"></span>)</span>&#123; <span class="built_in">console</span>.log(<span class="string">"D"</span>); &#125;;</span><br><span class="line">&gt; C.prototype.constructor = D; </span><br><span class="line">&gt; <span class="keyword">var</span> test = <span class="keyword">new</span> C(); </span><br><span class="line">C</span><br><span class="line">&gt; test.constructor</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">D</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">&gt; test <span class="keyword">instanceof</span> C</span><br><span class="line"><span class="literal">true</span>        <span class="comment">// Object.getPrototypeOf(test) === C.prototype</span></span><br><span class="line">&gt; test <span class="keyword">instanceof</span> D</span><br><span class="line"><span class="literal">false</span></span><br></pre></td></tr></table></figure></p>
<p>See, the constructor property doesn’t change the function called when we new an object.</p>
<h4 id="jQuery_u2019s_Constructor"><a href="#jQuery_u2019s_Constructor" class="headerlink" title="jQuery’s Constructor"></a>jQuery’s Constructor</h4><p>So how does jQuery bind the functions in <code>jQuery.fn</code> to jQuery instance ?<br>Actually when we call <code>jQuery(&quot;bula&quot;)</code> / <code>$(&quot;bula&quot;)</code>, a new <code>jQuery.fn.init</code> object is created. And <code>jQuery.fn</code> is assigned to <code>jQuery.fn.init.prototype</code> </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> jQuery = <span class="function"><span class="keyword">function</span>(<span class="params"> selector, context </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> jQuery.fn.init( selector, context );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">init = jQuery.fn.init = <span class="function"><span class="keyword">function</span>(<span class="params"> selector, context </span>) </span>&#123;</span><br><span class="line">	<span class="comment">/* initialize */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Give the init function the jQuery prototype for later instantiation</span></span><br><span class="line">init.prototype = jQuery.fn;</span><br></pre></td></tr></table></figure>
<p>So every jQuery instance (actually is jQuery.fn.init instance) can access the <code>jQuery.fn</code> through prototype chain.</p>
<p>In conclusion, a jQuery instance will have these properties:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> test = $(<span class="string">"div"</span>);</span><br><span class="line">test.__proto__ === jQuery.fn;</span><br><span class="line">test.__proto__.constructor === jQuery;</span><br></pre></td></tr></table></figure></p>
<h4 id="jQuery-fn-init"><a href="#jQuery-fn-init" class="headerlink" title="jQuery.fn.init"></a>jQuery.fn.init</h4><p>jQuery is the main entrance, below are 10 possible invoke patterns:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>);				<span class="comment">// $(DOMElement)</span></span><br><span class="line">$(<span class="string">'&lt;div&gt;'</span>);				<span class="comment">// $(html)</span></span><br><span class="line">$(<span class="string">'div'</span>);				<span class="comment">// $(expr)</span></span><br><span class="line">$(<span class="string">'#test'</span>);				<span class="comment">// $(#id)</span></span><br><span class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;);			<span class="comment">// $(function)</span></span><br><span class="line">$(<span class="string">"input:radio"</span>, <span class="built_in">document</span>.forms[<span class="number">0</span>]); <span class="comment">//$(expr, context)</span></span><br><span class="line">$(<span class="string">'input'</span>, $(<span class="string">'div'</span>));	 <span class="comment">// $(expr, $(...))</span></span><br><span class="line">$();					<span class="comment">// $(""), $(null), $(undefined), $(false)</span></span><br><span class="line">$(<span class="string">"&lt;div&gt;"</span>, &#123;		</span><br><span class="line">         <span class="string">"class"</span>: <span class="string">"test"</span>,</span><br><span class="line">         text: <span class="string">"Click me!"</span>,</span><br><span class="line">         click: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; $(<span class="keyword">this</span>).toggleClass(<span class="string">"test"</span>); &#125;</span><br><span class="line">	&#125;);                  <span class="comment">// $(html, props)</span></span><br><span class="line">$($(<span class="string">'.test'</span>));		   <span class="comment">// $($(...))</span></span><br></pre></td></tr></table></figure></p>
<p>Before we start looking into the constructor (<code>core/init.js</code>), we need gain some knowledge about <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp/exec" target="_blank" rel="external">RegExp.prototype.exec()</a>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> rquickExpr = <span class="regexp">/^(?: nbs*(&lt;[\w\W]+&gt;)[^&gt;]*|#([\w-]*))$/</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//["&lt;div&gt;", "div", undefined]</span></span><br><span class="line"><span class="keyword">var</span> match = rquickExpr.exec(<span class="string">"&lt;div&gt;"</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">//["#bula", undefined, "bula"]</span></span><br><span class="line">match = rquickExpr.exec(<span class="string">"#bula"</span>);</span><br></pre></td></tr></table></figure>
<p>The <code>rquickExpr</code> regex match two patterns: html(<code>&lt;div&gt;</code>) and id(<code>#div</code>). The <code>match</code> array contain three elements: [matched substring, html, id]. Since exec function(without global flag <code>g</code>) only matches the first eligible, there must be an “undefined” between the 2nd and 3rd elements.</p>
<p>Tips: <code>(?:x)</code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp#grouping-back-references" target="_blank" rel="external">[4]</a> matches x but does not remember the match. These are called non-capturing parentheses. The matched substring can not be recalled from the resulting array’s elements [1], …, [n] or from the predefined RegExp object’s properties <code>$1</code>, …, <code>$9</code>.</p>
<p>jQuery handles these 10 cases in <code>jQuery.fn.init</code>:<br><figure class="highlight"><figcaption><span>analysis</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">var	rquickExpr = /^(?:\s*(&lt;[\w\W]+&gt;)[^&gt;]*|#([\w-]*))$/,</span><br><span class="line">	rsingleTag = (/^&lt;(\w+)\s*\/?&gt;(?:&lt;\/\1&gt;|)$/);</span><br><span class="line"></span><br><span class="line">jQuery.fn.init = function( selector, context ) &#123;</span><br><span class="line">	var match, elem;</span><br><span class="line"></span><br><span class="line">	// HANDLE: $(""), $(null), $(undefined), $(false)</span><br><span class="line">	// pattern 8: $()</span><br><span class="line">	if ( !selector ) &#123;</span><br><span class="line">		return this;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Handle HTML strings</span><br><span class="line">	if ( typeof selector === "string" ) &#123;</span><br><span class="line">		if ( selector.charAt(0) === "&lt;" &amp;&amp; selector.charAt( selector.length - 1 ) === "&gt;" &amp;&amp; selector.length &gt;= 3 ) &#123;</span><br><span class="line">			// Assume that strings that start and end with &lt;&gt; are HTML and skip the regex check</span><br><span class="line">			match = [ null, selector, null ];</span><br><span class="line"></span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			match = rquickExpr.exec( selector );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// Match html or make sure no context is specified for #id</span><br><span class="line">		if ( match &amp;&amp; (match[1] || !context) ) &#123;</span><br><span class="line"></span><br><span class="line">			// HANDLE: $(html) -&gt; $(array)</span><br><span class="line">			if ( match[1] ) &#123;</span><br><span class="line">				context = context instanceof jQuery ? context[0] : context;</span><br><span class="line"></span><br><span class="line">				// scripts is true for back-compat</span><br><span class="line">				// Intentionally let the error be thrown if parseHTML is not present</span><br><span class="line">				jQuery.merge( this, jQuery.parseHTML(</span><br><span class="line">					match[1],</span><br><span class="line">					context &amp;&amp; context.nodeType ? context.ownerDocument || context : document,</span><br><span class="line">					true</span><br><span class="line">				) );</span><br><span class="line"></span><br><span class="line">				// HANDLE: $(html, props) </span><br><span class="line">				// pattern 9</span><br><span class="line">				if ( rsingleTag.test( match[1] ) &amp;&amp; jQuery.isPlainObject( context ) ) &#123;</span><br><span class="line">					for ( match in context ) &#123;</span><br><span class="line">						// Properties of context are called as methods if possible</span><br><span class="line">						if ( jQuery.isFunction( this[ match ] ) ) &#123;</span><br><span class="line">							this[ match ]( context[ match ] );</span><br><span class="line"></span><br><span class="line">						// ...and otherwise set as attributes</span><br><span class="line">						&#125; else &#123;</span><br><span class="line">							this.attr( match, context[ match ] );</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				return this;</span><br><span class="line"></span><br><span class="line">			// HANDLE: $(#id)</span><br><span class="line">			&#125; else &#123;</span><br><span class="line">				elem = document.getElementById( match[2] );</span><br><span class="line"></span><br><span class="line">				// Check parentNode to catch when Blackberry 4.6 returns</span><br><span class="line">				// nodes that are no longer in the document #6963</span><br><span class="line">				if ( elem &amp;&amp; elem.parentNode ) &#123;</span><br><span class="line">					// Handle the case where IE and Opera return items</span><br><span class="line">					// by name instead of ID</span><br><span class="line">					if ( elem.id !== match[2] ) &#123;</span><br><span class="line">						// rootjQuery = jQuery( document );</span><br><span class="line">						return rootjQuery.find( selector );</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					// Otherwise, we inject the element directly into the jQuery object</span><br><span class="line">					this.length = 1;</span><br><span class="line">					this[0] = elem;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				this.context = document;</span><br><span class="line">				this.selector = selector;</span><br><span class="line">				return this;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		// HANDLE: $(expr, $(...))</span><br><span class="line">		// pattern 3,7: $('div'), $('input', $('div')) </span><br><span class="line">		&#125; else if ( !context || context.jquery ) &#123;</span><br><span class="line">			return ( context || rootjQuery ).find( selector );</span><br><span class="line"></span><br><span class="line">		// HANDLE: $(expr, context)</span><br><span class="line">		// pattern 6: $("input:radio", document.forms[0]);</span><br><span class="line">		// (which is just equivalent to: $(context).find(expr)</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			return this.constructor( context ).find( selector );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	// HANDLE: $(DOMElement)</span><br><span class="line">	// pattern 1: $(document)</span><br><span class="line">	&#125; else if ( selector.nodeType ) &#123;</span><br><span class="line">		this.context = this[0] = selector;</span><br><span class="line">		this.length = 1;</span><br><span class="line">		return this;</span><br><span class="line"></span><br><span class="line">	// HANDLE: $(function)</span><br><span class="line">	// Shortcut for document ready</span><br><span class="line">	&#125; else if ( jQuery.isFunction( selector ) ) &#123;</span><br><span class="line">		return typeof rootjQuery.ready !== "undefined" ?</span><br><span class="line">			rootjQuery.ready( selector ) :</span><br><span class="line">			// Execute immediately if ready is not present</span><br><span class="line">			selector( jQuery );</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	// pattern 10: $($('.test'))</span><br><span class="line">	if ( selector.selector !== undefined ) &#123;</span><br><span class="line">		this.selector = selector.selector;</span><br><span class="line">		this.context = selector.context;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return jQuery.makeArray( selector, this );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">#region code anlysis</span><br><span class="line">1-2: bulabula</span><br><span class="line">3-6: bulalllala</span><br><span class="line">9-15: eiheiehi</span><br><span class="line">#endregion</span><br></pre></td></tr></table></figure></p>
<p>According to the constructor, we can understand the structure of jQuery object easily.<br>If the selected element is a single DOM element, such as <code>$(#id)</code> and <code>$(DOMElement)</code>, then the DOM element will be assigned to <code>this[0]</code>.<br>You can convert the jQuery object and DOM element to each other easily.<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DOM element to jQuery object</span></span><br><span class="line"><span class="variable"><span class="keyword">var</span> domelem</span> = document.getElementById(<span class="string">"target"</span>);</span><br><span class="line"><span class="variable"><span class="keyword">var</span> jqobj</span> = $(domelem);</span><br><span class="line"></span><br><span class="line"><span class="comment">// jQuery object to DOM element</span></span><br><span class="line"><span class="variable"><span class="keyword">var</span> bula</span> = jqobj.<span class="keyword">get</span>(); <span class="comment">// will discuss this method in next post</span></span><br><span class="line"><span class="comment">// Since the target is a single DOM element</span></span><br><span class="line"><span class="comment">// we can also convert back using the code below</span></span><br><span class="line">bula = jqobj[<span class="number">0</span>];</span><br></pre></td></tr></table></figure></p>
<h4 id="new_SomeFunction_28_29_vs_Object-create_28SomeFunction_29*"><a href="#new_SomeFunction_28_29_vs_Object-create_28SomeFunction_29*" class="headerlink" title="new SomeFunction() vs Object.create(SomeFunction)*"></a>new SomeFunction() vs Object.create(SomeFunction)*</h4><p>Except for <code>new SomeFunction()</code>, there is another way to create object: <code>Object.create(SomeFunction)</code>.</p>
<p>The object used in Object.create actually forms the prototype of the new object (if the first parameter has a prototype property), where as in the new Function() form the declared properties/functions do not form the prototype<a href="http://stackoverflow.com/questions/4166616/understanding-the-difference-between-object-create-and-new-somefunction-in-j" target="_blank" rel="external">[6]</a>.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">var</span> test = <span class="keyword">new</span> <span class="built_in">Object</span>();</span><br><span class="line">&gt; <span class="keyword">var</span> test2 = <span class="built_in">Object</span>.create(<span class="built_in">Object</span>);</span><br><span class="line">&gt; test.prototype</span><br><span class="line"><span class="literal">undefined</span></span><br><span class="line">&gt; test2.prototype</span><br><span class="line"><span class="built_in">Object</span> &#123;&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>new X()</code> is <code>Object.create(X.prototype)</code> with additionally running the constructor function. (And giving the constructor the chance to return the actual object that should be the result of the expression instead of this.)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://unicorn-42.com/2014/11/25/jQuery Source Code Study 1 - Basic Structure/" data-id="cihxitpv50003lcq5je8fzte7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jQuery/">jQuery</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/11/30/jQuery Source Code Study 2 - Core Module/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          jQuery Source Code Study 2 - Core Module
        
      </div>
    </a>
  
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/jQuery/">jQuery</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/jQuery/" style="font-size: 10px;">jQuery</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/12/08/[译]安全基础：GPG, OpenSSH和OpenSSL/">GPG, OpenSSH &amp; OpenSSL</a>
          </li>
        
          <li>
            <a href="/2014/11/30/jQuery Source Code Study 2 - Core Module/">jQuery Source Code Study 2 - Core Module</a>
          </li>
        
          <li>
            <a href="/2014/11/25/jQuery Source Code Study 1 - Basic Structure/">jQuery Source Code Study 1 - Basic Structure</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 byunicorn<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>