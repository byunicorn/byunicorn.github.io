<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>byunicorn&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="byunicorn's blog">
<meta property="og:url" content="http://unicorn-42.com/index.html">
<meta property="og:site_name" content="byunicorn's blog">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="byunicorn's blog">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="byunicorn&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">byunicorn&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://unicorn-42.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-[译]安全基础：GPG, OpenSSH和OpenSSL" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/08/[译]安全基础：GPG, OpenSSH和OpenSSL/" class="article-date">
  <time datetime="2015-12-08T15:01:37.000Z" itemprop="datePublished">2015-12-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/08/[译]安全基础：GPG, OpenSSH和OpenSSL/">GPG, OpenSSH &amp; OpenSSL</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="u4ECB_u7ECD"><a href="#u4ECB_u7ECD" class="headerlink" title="介绍"></a>介绍</h1><p>这篇文章并不打算向你介绍“如何保证安全性”——我并不是一个安全方面的专家。正如标题所述，这是一篇关于安全基础的文章。如果你正在维护生产环境下的应用或者服务，那么请去咨询安全方面的专家。</p>
<blockquote><p>注：虽然读起来很艰涩，但是还是强烈推荐Ivan Ristić的“Bulletproof SSL and TLS”</p>
</blockquote>
<p>这篇文章的实际目的有两个：</p>
<ol>
<li>巩固自己对下面即将提到的一些工具的理解</li>
<li>也帮助他人理解使用这些工具的目的</li>
</ol>
<p>安全性这个话题经常会令人感到困惑。我花了很长时间去理解这里将要讨论的内容，本文主要包含以下几点：</p>
<ul>
<li>什么是密钥，它们是如何工作的？</li>
<li>理解PKI</li>
<li>OpenSSL vs OpenSSH</li>
<li>什么是GPG</li>
<li>生成你自己的密钥</li>
<li>如何用GPG和OpenSSL来加密数据</li>
</ul>
<h2 id="u660E_u6587_28Plaintext_29_u548C_u5BC6_u7801_28Ciphers_29"><a href="#u660E_u6587_28Plaintext_29_u548C_u5BC6_u7801_28Ciphers_29" class="headerlink" title="明文(Plaintext)和密码(Ciphers)"></a>明文(Plaintext)和密码(Ciphers)</h2><p>这篇文章里将多次提到“明文”和“密文”这两个词。在开始正文前，我们先要理解这两个词的含义：<br>一个没被加密过的文件我们称之为明文，反之，加密过的称为密文。</p>
<h1 id="u5BC6_u94A5_u662F_u4EC0_u4E48_uFF0C_u5B83_u4EEC_u662F_u5982_u4F55_u5DE5_u4F5C_u7684_uFF1F"><a href="#u5BC6_u94A5_u662F_u4EC0_u4E48_uFF0C_u5B83_u4EEC_u662F_u5982_u4F55_u5DE5_u4F5C_u7684_uFF1F" class="headerlink" title="密钥是什么，它们是如何工作的？"></a>密钥是什么，它们是如何工作的？</h1><p>假设你有一个包含着密码的明文文件，你想通过互联网将它分享给你的朋友“Bob”。</p>
<p>你可以打开邮箱（或者聊天程序），将文件发送给Bob。但是这并不安全，因为可能会有坏人“嗅探”你的网络通信，他会监听你们之间的交流并窃取包含着密码的明文文件。</p>
<p>为了阻止这种事情发生，我们需要将明文文件加密成密文再进行传输。这样即使有人截取了你们之间传输的信息，也只能得到加密后的密码。</p>
<p>为了将明文加密，我们需要依赖一个叫做“密钥”的技术。密钥是一种参数，它是在明文转换为密文或将密文转换为明文的数学算法中输入的参数。</p>
<blockquote>
<p> 注：密钥越长，加密就越安全。这就是为什么当我们生成密钥时，你通常会被要求输入想要生成的密钥的大小（比如，128 bit）。</p>
</blockquote>
<p>但是为了让接收方Bob知道如何解密你发送过去的密文，你还需要让Bob知道你在使用的密钥和加密算法。</p>
<p>你不能发邮件给Bob说“我用了算法X和这串密钥生成了这段密文”，因为坏人也可能截获你的这段信息。</p>
<h2 id="u516C_u94A5_u52A0_u5BC6"><a href="#u516C_u94A5_u52A0_u5BC6" class="headerlink" title="公钥加密"></a>公钥加密</h2><p>为了解决“不能够安全地传递用于加密的密钥”的问题，有些机智的家伙设计了“公钥加密”的方案，其原理是生成2个密钥：一个公钥(public-key)，一个私钥(private-key)。</p>
<p>可能你已经猜到了，公钥是可以被“公开”的（就算坏人得到了公钥也不是什么大问题），而私钥则是不可以分享给任何人的（这一点非常重要）。</p>
<p>那么这两个密钥是如何工作的呢？</p>
<p>关键在于这两个密钥是对方在数学上的倒数(原文是mathematical inverse，翻成倒数不知是否合适)，意味着，你既可以使用公钥也可以使用私钥加密文件，但只有交替使用对应的密钥才可以进行解密。所以，如果你使用你的公钥加密明文文件，那么唯一解密的方法就是使用你的私钥。而私钥是只有你自己知道的，这就意味着，只有你才能解开被公钥加密过的密文。好了，你要传输的文件安全了~</p>
<p>现在，我们对公钥加密有了一个基本的了解。你应该可以想象出要如何使用这套技术了，让我们回到前面Bob的例子吧。</p>
<h2 id="u516C_u94A5_u52A0_u5BC6_u793A_u4F8B"><a href="#u516C_u94A5_u52A0_u5BC6_u793A_u4F8B" class="headerlink" title="公钥加密示例"></a>公钥加密示例</h2><blockquote>
<p> 注：这个例子是不安全的，我后面会解释原因</p>
</blockquote>
<p>在这个例子里，有一个前提：</p>
<ol>
<li>Bob生成了自己的公钥和私钥</li>
</ol>
<p>在了解了公钥加密的思路之后，下面的步骤就变得很好理解了：</p>
<ul>
<li>我发邮件向Bob索要他的公钥</li>
<li>Bob将他的公钥发给我</li>
<li>我将自己的密码用Bob的公钥加密</li>
<li>我将加密后的密文发送给Bob</li>
<li>Bob收到了密文并用他自己的私钥解密</li>
<li>Bob获得我的密码</li>
</ul>
<p>在一个理想的世界里，这一套步骤非常完美。但是，现实是残酷的，可能你已经发觉了问题，如果没有，我将解释为什么这套步骤是不安全的：坏人可能截获你向Bob索要公钥的邮件，并将自己的公钥回复给你，结果你以为得到的是Bob的公钥，但实际上是坏人生成的公钥。</p>
<p>接下来，如果你用坏人给你的公钥加密密码发送给Bob，坏人可以再次拦截你的通信，并用私钥解密密文，最终得到你的明文密码。</p>
<h2 id="u8BA4_u8BC1"><a href="#u8BA4_u8BC1" class="headerlink" title="认证"></a>认证</h2><p>好了，我们到达了另外一个重要的安全问题：“认证”。意思是说：如何确认真正和我们通信的人是谁。</p>
<p>你可能会想，为了让别人可以安全地识别自己的身份，我们每个人可以把自己的公钥放到网上。这意味着当你需要别人的公钥的时候，不用通过不安全的通信信道索取，对方可以给你一个安全的地址，你可以去那里拿对方的公钥。例如，<a href="https://keybase.io/就提供了这样的服务（该网站还在预览阶段）。除此之外，还有一些其他网站也提供了类似服务，比如：keyserver.ubuntu.com" target="_blank" rel="external">https://keybase.io/就提供了这样的服务（该网站还在预览阶段）。除此之外，还有一些其他网站也提供了类似服务，比如：keyserver.ubuntu.com</a>, pgp.mit.edu 和 keyserver.pgp.com。</p>
<blockquote>
<p> 注：你可以从这里拿到我的公钥：keybase.io/integralist</p>
</blockquote>
<p>但是除非你在现实生活中或是通过电话和你希望通信的人直接沟通，否则你无法知道发布公钥的人就是你的目标对象。“认证”是一个难以解决的问题，而这就给了PKI（公钥基础设施）用武之地。</p>
<h1 id="u7406_u89E3PKI_uFF08_u516C_u94A5_u57FA_u7840_u8BBE_u65BD_uFF09"><a href="#u7406_u89E3PKI_uFF08_u516C_u94A5_u57FA_u7840_u8BBE_u65BD_uFF09" class="headerlink" title="理解PKI（公钥基础设施）"></a>理解PKI（公钥基础设施）</h1><p>PKI是建立在公钥加密技术的基础之上的。区别在于，PKI引入了“证书”的概念。在软件领域里，“证书”就像是我们的护照一样。</p>
<p>在现实生活中，政府是一个值得信赖的权威机构（好吧，现在可能这个说法有些问题，就先当所有政府都是可信任的吧）。政府会给你发放护照，其中包含的信息可以唯一地标示你的身份。在数字世界里，证书发挥着类似的功能。</p>
<p>必须指出的是，证书是用来识别网站，而不是某个特定的人，因此PKI是建立在你和一个网站/服务器通信的前提下的。PKI并不能解决我们上面提到的给Bob传送密码的安全问题。（稍后我会回到这个问题上）</p>
<blockquote>
<p> 注：技术上“证书”是使用<a href="https://en.wikipedia.org/wiki/X.509" target="_blank" rel="external">X.509</a>标准创建的</p>
</blockquote>
<p>当你访问一个网站时，PKI可以帮你验证你（如web浏览器）是在和正确的端点（endpoint）通信。这点非常有用，因为如果你在做一些网上的银行业务，你需要确认你是在和真正的银行网点沟通，而不是一些尝试获得你账户信息的钓鱼网站。</p>
<p>PKI管理验证端点（例如某些你在访问的网站/服务）的方式是使用证书。当你访问一个站点，你会使用http或者https协议。用https意味着站点和浏览器之间建立的是一个安全的链接，如果该网站持有有效的证书，那么你的浏览器就会知道自己在与正确的站点进行通信。</p>
<p>为什么我们可以信任证书呢？坏人也可以建立一个看起来像银行网站的钓鱼网站，然后创建一个证书并将其与自己的网站域名相关联。是的，这是可能的，但PKI的理念是建立在“信任网”（web of trust）之上的。让我来解释一下这是什么意思。</p>
<h2 id="u8BC1_u4E66_u9881_u53D1_u673A_u6784_uFF08CAs_uFF09"><a href="#u8BC1_u4E66_u9881_u53D1_u673A_u6784_uFF08CAs_uFF09" class="headerlink" title="证书颁发机构（CAs）"></a>证书颁发机构（CAs）</h2><p>你的浏览器里存有它所信任的组织名单（所谓的“CA”或者证书颁发机构），这些组织可以颁发证书。</p>
<p>如果一个网站使用非可信CA发行（即“签名”）的证书，那么你的浏览器会显示一个警告：你不应该继续访问该网站，无法证实该网站的身份。（即，这个网站说自己是银行的官网，但是我们不能真正信任它，因为它的证书并不是我们所信任的CA颁发的）</p>
<blockquote>
<p> 注：证书创建后会使用CA的私钥进行加密（即“签名”）。因为CA的公钥是公开的，所以我们的浏览器可以使用CA的公钥来验证网站提供的证书是否来自于可信的CA。</p>
</blockquote>
<p>那么这些可信任的组织（CA）是从哪里来的呢？好了，你可以想象，想成为授权的CA需要经过一套很高成本的复杂流程。因为我们必须绝对地信任CA会保证我们的利益（CA只能给已经通过严格的登记程序并证实了自己真实身份的公司/组织核发证书）。</p>
<h2 id="u4E2D_u95F4CA_28Intermediate_CA_29"><a href="#u4E2D_u95F4CA_28Intermediate_CA_29" class="headerlink" title="中间CA(Intermediate CA)"></a>中间CA(Intermediate CA)</h2><p>现在的CA有时也会创建中间CA，这些中间CA可以代表原CA（也称为“根CA”）颁发证书。如果你访问的网站有证书，你可以查看这个证书是由中间CA还是根CA颁发的。如果这个网站的证书来自于中间CA，你可以顺着找到对应的根CA。（一般来说，你的浏览器会帮你完成这项工作）</p>
<p>这样做的其中一个原因是根CA是非常重要的。如果它的私钥被图谋不轨的人得到了，那么可能就会给一些恶意网站颁发证书。</p>
<p>在现实世界里，一旦一个根CA被建立起来，它的私钥会被离线地存放起来。例如，含有私钥的硬盘会被存放到防火的地方（甚至输入端都会被胶水填充起来，防止有人窃取并试图提取里面的数据）。</p>
<h2 id="u8BC1_u4E66_u540A_u9500_u5217_u8868_uFF08CRLs_uFF09"><a href="#u8BC1_u4E66_u540A_u9500_u5217_u8868_uFF08CRLs_uFF09" class="headerlink" title="证书吊销列表（CRLs）"></a>证书吊销列表（CRLs）</h2><p>颁发的证书都有个有效期。每次你的浏览器检查网站的证书时，都会检查证书的有效期。如果已经过期，那么浏览器就会警告你这个网站的证书已过期。</p>
<p>同时，如果证书尚未过期，那么你的浏览器会检查CRL，看看证书是否已经被吊销。CRL是由你的浏览器/操作系统定期下载更新的。那么问题来了：它们不是实时的结果。</p>
<p>想象一下，一个颁发给www.foo.com的证书随后被撤销了（无论是因为何种原因）。在这种情况下，www.foo.com不能被信任，但是你本地的浏览器还没有更新到最新的CRL，如果你此时访问该网站，那么它的证书仍然是被看作为有效的了。</p>
<p>由于缺乏实时验证，在线证书状态协议（Online Certificate Status Protocal, OCSP）已经取代CRL，正如名字所示的那样，OCSP允许你实时地查询网上资源以验证证书的有效性。</p>
<h1 id="SSL__u548C_TLS"><a href="#SSL__u548C_TLS" class="headerlink" title="SSL 和 TLS"></a>SSL 和 TLS</h1><p>到目前为止，我们一直在讨论的“证书”解决了验证服务器身份的问题，其中PKI是保护通信安全的重要机制。</p>
<p>为了帮助PKI实现其目标，一个叫SSL（安全套接字层）的加密协议被设计了出来。这个协议后来被一个新的协议TLS（传输层安全）所取代。PKI使用这些协议来实现安全通信。</p>
<blockquote>
<p>注：你可能会问，当你听到PKI安全的时候，为什么你经常听到的是SSL，而不是TSL这个词。这是因为SSL已经成为了一个大多数人都认识和理解的营销术语。大部分情况下，如果有人提到SSL，那么他们真正的意思很可能是：他们正在使用TLS协议。</p>
</blockquote>
<h2 id="SSL_u63E1_u624B_uFF08_u5BC6_u7801_u5957_u4EF6_u548C_u5BC6_u94A5_u4EA4_u6362_uFF09"><a href="#SSL_u63E1_u624B_uFF08_u5BC6_u7801_u5957_u4EF6_u548C_u5BC6_u94A5_u4EA4_u6362_uFF09" class="headerlink" title="SSL握手（密码套件和密钥交换）"></a>SSL握手（密码套件和密钥交换）</h2><p>为了确保客户端和服务器之间的通信，我们会遵照协议里定义的一系列步骤，这一系列步骤通常称为“SSL握手”。</p>
<p>记得我们之前讨论过公钥加密是如何保证通信信道安全的，但是我们还不知道怎样才能不暴露我们的加密密钥给任何嗅探通信信道的人。</p>
<p>SSL握手的步骤之一被称为“密钥交换”。客户端/服务器之间将进行加密密钥的交换，这项交换将使用一种公钥加密算法完成。当前最流行的选择是RSA算法，在把通信的密钥发送给服务器之前，我们将会使用服务器的公钥（由服务器发送给客户端的证书中提供）对密钥进行加密。</p>
<blockquote>
<p>注：如果你使用Diffie-Hellman密钥交换算法，你会发现它采用“混合颜色”来比喻隐藏在公式背后的数学算法。（即，向某一个方向的计算比较容易，反之则比较困难，就如同混合两种颜色很容易，但是分离两种颜色则十分不易）。在选择算法的时候，你也要考虑一些高级密钥交换算法所带来的性能损失。</p>
</blockquote>
<p>为了使SSL握手成功进行，客户端需要向服务器提供一些初始设定，其中一个就是“加密套件”。加密套件有一个结构，看起来像下面这样：</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TLS_RS<span class="built_in">A_WITH</span>_AES_128_CBC_SHA</span><br></pre></td></tr></table></figure>
<p>这看起来可能就像是一串混乱的缩略词，让我们来详细解释一下：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">TLS</span>: <span class="string">使用的协议</span></span><br><span class="line"><span class="attribute">RSA</span>: <span class="string">密钥交换算法</span></span><br><span class="line"><span class="attribute">AES</span>: <span class="string">加密算法</span></span><br><span class="line"><span class="attribute">128</span>: <span class="string">密钥长度</span></span><br><span class="line"><span class="attribute">CBC</span>: <span class="string">加密模式</span></span><br><span class="line"><span class="attribute">SHA</span>: <span class="string">the hash function for a digital signature</span></span><br></pre></td></tr></table></figure>
<p>在上面的例子中，RSA会被用作为密钥交换算法和认证机制。但是在其他加密套件中，你可能会看到不同的值（例如，DHE_RSA，其中DHE用于密钥交换，而RSA用于身份验证）。</p>
<p>客户端支持不同的加密套件算法，所以它很乐意发送各种能处理的组合，而服务器的任务是找到最安全合适的组合，并给予客户端响应，以确认选择的加密套件。</p>
<blockquote>
<p> 注：加密套件是会被MITM（中间人）攻击的一个通信领域。例如，图谋不轨的嗅探者拦截到你一开始时没有加密的通信，将加密套件中其他备选删除，只留下最容易破解的那一个。服务器没有选择，只能选择套件中仅剩的选项。这意味着，攻击者可以更容易地暴力破解薄弱的加密算法。</p>
</blockquote>
<p>另外，我们还需要知道的一个术语是MAC（消息验证码）。MAC是一种确保认证和完整性的方法，MAC会结合密钥和散列码为内容进行签名，产生一个摘要值，简单地说，MAC就是带密钥的哈希函数（计算消息的摘要值时，密钥和消息内容都会作为输入）。当我们发送数据时我们会附带一个MAC，因为发送端和接收端两边都有密钥/加密信息，我们可以保证信息的内容没有被篡改。等会儿我们就会看到，握手的步骤之一是客户端/服务器使用MAC对对方进行验证。</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/08/MAC.svg/661px-MAC.svg.png" alt=""></p>
<p>让我们来快速浏览一下SSL握手的步骤（并不是详尽的步骤，为了简洁，我已经省略了很多）：</p>
<ol>
<li>客户端发送一个加密套件，一个随机数（稍后用于生成”对话密钥”），一协议版本和压缩方法的列表，即ClientHello消息</li>
<li>服务器回复一个选定的加密套件，一个随机数（稍后用于生成”对话密钥”），它支持的协议版本和选择的压缩方法，即SeverHello消息</li>
<li>客户端请求证书进行身份鉴定 **</li>
<li>服务器发送它的证书</li>
<li>客户端通过PKI验证证书，从中取出服务器的公钥，客户端发送一个“预置密码”（pre-master-key），该密码用服务器的公钥加密，防止被窃听。</li>
<li>服务器解密，得到“预置密码”。</li>
<li><p>客户端/服务器双方都可以使用之前发送给对方的随机数和“预置密码”生成一个“主密码”，即对话密钥。至于为啥要用三个随机数来生成一个对话密钥，下面是摘自<a href="http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html" target="_blank" rel="external">SSL/TLS协议运行机制的概述</a>的解释：</p>
<blockquote>
<p> “不管是客户端还是服务器，都需要随机数，这样生成的密钥才不会每次都一样。由于SSL协议中证书是静态的，因此十分有必要引入一种随机因素来保证协商出来的密钥的随机性。<br>对于RSA密钥交换算法来说，pre-master-key本身就是一个随机数，再加上hello消息中的随机，三个随机数通过一个密钥导出器最终导出一个对称密钥。<br> pre master的存在在于SSL协议不信任每个主机都能产生完全随机的随机数，如果随机数不随机，那么pre master secret就有可能被猜出来，那么仅适用pre master secret作为密钥就不合适了，因此必须引入新的随机因素，那么客户端和服务器加上pre master secret三个随机数一同生成的密钥就不容易被猜出了，一个伪随机可能完全不随机，可是是三个伪随机就十分接近随机了，每增加一个自由度，随机性增加的可不是一。”</p>
</blockquote>
</li>
<li><p>客户端/服务器将会使用“对话密钥”作为对未来所有通信进行加密的密钥</p>
</li>
<li>客户端发送一个握手消息的MAC值（这里使用的密钥是“对话密钥”）</li>
<li>服务器也生成一个握手消息的MAC值，并与客户端发来的MAC进行比较（如果相同，则服务器切换成加密模式）</li>
<li>服务器告诉客户端自己已经准备好进行加密通信了</li>
<li>客户端开始发送安全的信息</li>
</ol>
<h2 id="u793A_u4F8B"><a href="#u793A_u4F8B" class="headerlink" title="示例"></a>示例</h2><p>在前面的小节里我简单介绍了服务器和客户端开始安全通信的步骤。但我还想补充一些这些消息的例子。</p>
<blockquote>
<p>注：这些例子都是从Ivan Ristić的“Bulletproof SSL and TLS”里拷贝出来的。</p>
</blockquote>
<p>这是第一个例子，客户端和服务器之间的开放通信：</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Handshake protocol: ClientHello</span><br><span class="line">    Version: TLS <span class="number">1.2</span></span><br><span class="line">    Random</span><br><span class="line">        Client time: May <span class="number">22</span>, <span class="number">2030</span> <span class="number">02</span>:<span class="number">43</span>:<span class="number">46</span> GMT</span><br><span class="line">        Random bytes: b76b0e61829557eb4c611adfd2d36eb232dc1332fe29802e321ee871</span><br><span class="line">    Session ID: (<span class="keyword">empty</span>)</span><br><span class="line">    Cipher Suites</span><br><span class="line">        Suite: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256”</span><br><span class="line">        Suite: TLS_DHE_RSA_WITH_AES_128_GCM_SHA256</span><br><span class="line">        Suite: TLS_RSA_WITH_AES_128_GCM_SHA256</span><br><span class="line">        Suite: TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA</span><br><span class="line">        Suite: TLS_DHE_RSA_WITH_AES_128_CBC_SHA</span><br><span class="line">        Suite: TLS_RSA_WITH_AES_128_CBC_SHA</span><br><span class="line">        Suite: TLS_RSA_WITH_3DES_EDE_CBC_SHA</span><br><span class="line">        Suite: TLS_RSA_WITH_RC4_128_SHA</span><br><span class="line">    Compression methods</span><br><span class="line">        <span class="function"><span class="keyword">Method</span>:</span> null</span><br><span class="line">    Extensions</span><br><span class="line">        <span class="keyword">Extension</span>: server_name</span><br><span class="line">            Hostname: www.feistyduck.com</span><br><span class="line">        <span class="keyword">Extension</span>: renegotiation_info</span><br><span class="line">        <span class="keyword">Extension</span>: elliptic_curves</span><br><span class="line">            Named curve: secp256r1</span><br><span class="line">            Named curve: secp384r1</span><br><span class="line">        <span class="keyword">Extension</span>: signature_algorithms</span><br><span class="line">            Algorithm: sha1/rsa</span><br><span class="line">            Algorithm: sha256/rsa</span><br><span class="line">            Algorithm: sha1/ecdsa</span><br><span class="line">            Algorithm: sha256/ecdsa”</span><br></pre></td></tr></table></figure>
<p>正如你所见，所有的成分都如我们之前所描述的一样。加密套件是这个阶段最需要注意的部分，让我们接下来看看服务器的响应：</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Handshake protocol: ServerHello</span><br><span class="line">    Version: TLS <span class="number">1.2</span></span><br><span class="line">    Random</span><br><span class="line">        Server time: Mar <span class="number">10</span>, <span class="number">2059</span> <span class="number">02</span>:<span class="number">35</span>:<span class="number">57</span> GMT”</span><br><span class="line">        Random bytes: <span class="number">8469</span>b09b480c1978182ce1b59290487609f41132312ca22aacaf5012</span><br><span class="line">    Session ID: <span class="number">4</span>cae75c91cf5adf55f93c9fb5dd36d19903b1182029af3d527b7a42ef1c32c80</span><br><span class="line">    Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</span><br><span class="line">    Compression <span class="function"><span class="keyword">method</span>:</span> null</span><br><span class="line">    Extensions</span><br><span class="line">        <span class="keyword">Extension</span>: server_name</span><br><span class="line">        <span class="keyword">Extension</span>: renegotiation_info”</span><br></pre></td></tr></table></figure>
<p>这里，我们可以看到服务器返回它的随机数据（用于构造预置密码），还有选定的加密套件。</p>
<h2 id="u9A8C_u8BC1SSL"><a href="#u9A8C_u8BC1SSL" class="headerlink" title="验证SSL"></a>验证SSL</h2><p>有时候你可能会需要调试SSL链接中的问题。为了做到这点，你会想要使用OpenSSL的程序命令s_client。它允许您使用SSL或TSL协议建立链接，还可以控制链接中的各种配置设定。</p>
<p>下面是个简单的例子：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">openssl</span> <span class="tag">s_client</span> <span class="tag">-connect</span> <span class="tag">google</span><span class="class">.com</span><span class="pseudo">:443</span> <span class="tag">-showcerts</span></span><br></pre></td></tr></table></figure>
<p>你会看到，我们正链接到谷歌（使用了SSL/TLS安全链接），我们还加上了<code>-showcerts</code>标志，它允许显示响应中所有服务器提供的证书。</p>
<p>下面是响应的实例：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">CONNECTED</span>(<span class="number">00000003</span>)</span><br><span class="line"><span class="label">depth</span><span class="number">=2</span> /C<span class="label">=US</span>/O<span class="label">=GeoTrust</span> Inc./<span class="preprocessor">CN</span><span class="label">=GeoTrust</span> <span class="preprocessor">Global</span> CA</span><br><span class="line"><span class="label">verify</span> error:num<span class="number">=20</span>:unable to <span class="preprocessor">get</span> local issuer certificate</span><br><span class="line"><span class="label">verify</span> return:<span class="number">0</span></span><br><span class="line">---</span><br><span class="line"><span class="label">Certificate</span> chain</span><br><span class="line"> <span class="number">0</span> s:/C<span class="label">=US</span>/ST<span class="label">=California</span>/L<span class="label">=Mountain</span> View/O<span class="label">=Google</span> Inc/<span class="preprocessor">CN</span>=*.google.com</span><br><span class="line">   i:/C<span class="label">=US</span>/O<span class="label">=Google</span> Inc/<span class="preprocessor">CN</span><span class="label">=Google</span> Internet Authority G2</span><br><span class="line">-----<span class="keyword">BEGIN </span>CERTIFICATE-----</span><br><span class="line"><span class="label">MIIHjTCCBnWgAwIBAgIIGo</span>+tp3jIDvEwDQYJKoZIhvcNAQELBQAwSTELMAkGA1UE</span><br><span class="line"><span class="keyword">BhMCVVMxEzARBgNVBAoTCkdvb2dsZSBJbmMxJTAjBgNVBAMTHEdvb2dsZSBJbnRl</span><br><span class="line"></span><span class="label">cm5ldCBBdXRob3JpdHkgRzIwHhcNMTUxMDE1MTY0MTE2WhcNMTYwMTEzMDAwMDAw</span></span><br><span class="line"><span class="label">WjBmMQswCQYDVQQGEwJVUzETMBEGA1UECAwKQ2FsaWZvcm5pYTEWMBQGA1UEBwwN</span></span><br><span class="line"><span class="label">TW91bnRhaW4gVmlldzETMBEGA1UECgwKR29vZ2xlIEluYzEVMBMGA1UEAwwMKi5n</span></span><br><span class="line"><span class="keyword">b29nbGUuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEApCZxkmtf</span><br><span class="line"></span><span class="label">Au04O0RjThQnFAzC27w9VlfAoQrgqPtarJIvQDw4G8NZEUSWIlPr0nGr5z3CicxY</span></span><br><span class="line"><span class="label">ddO2</span>+U8vz/aEltcIUDqNNsdordbLLl7zBS2zkDnSZEmJcM5wYM8biJ3FSU3WzRmN</span><br><span class="line"><span class="label">o8px1LCj49dpQButCJ7FCDIU3eaxZRYZaEiO2UCR7BT8wdyE9O49YKcDUycTgaNu</span></span><br><span class="line"><span class="label">pM5oTFPqqj</span>+<span class="number">3</span>mDLZsB8BjIssboE8dutdU0TTY4SJ3EPFsSeVTOFu7WY+s628hwMw</span><br><span class="line"><span class="label">kw5sy9viYUZf11RL0zleKarvdQ</span>+oE6gK59ilknrrRXONpepKX6cBGwF/cF+Xl4y4</span><br><span class="line"><span class="label">tjvbvWfNETvmPQIDAQABo4IEWjCCBFYwHQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsG</span></span><br><span class="line"><span class="label">AQUFBwMCMIIDJgYDVR0RBIIDHTCCAxmCDCouZ29vZ2xlLmNvbYINKi5hbmRyb2lk</span></span><br><span class="line"><span class="label">LmNvbYIWKi5hcHBlbmdpbmUuZ29vZ2xlLmNvbYISKi5jbG91ZC5nb29nbGUuY29t</span></span><br><span class="line"><span class="label">ghYqLmdvb2dsZS1hbmFseXRpY3MuY29tggsqLmdvb2dsZS5jYYILKi5nb29nbGUu</span></span><br><span class="line"><span class="label">Y2yCDiouZ29vZ2xlLmNvLmlugg4qLmdvb2dsZS5jby5qcIIOKi5nb29nbGUuY28u</span></span><br><span class="line"><span class="label">dWuCDyouZ29vZ2xlLmNvbS5hcoIPKi5nb29nbGUuY29tLmF1gg8qLmdvb2dsZS5j</span></span><br><span class="line"><span class="keyword">b20uYnKCDyouZ29vZ2xlLmNvbS5jb4IPKi5nb29nbGUuY29tLm14gg8qLmdvb2ds</span><br><span class="line"></span><span class="label">ZS5jb20udHKCDyouZ29vZ2xlLmNvbS52boILKi5nb29nbGUuZGWCCyouZ29vZ2xl</span></span><br><span class="line"><span class="label">LmVzggsqLmdvb2dsZS5mcoILKi5nb29nbGUuaHWCCyouZ29vZ2xlLml0ggsqLmdv</span></span><br><span class="line"><span class="keyword">b2dsZS5ubIILKi5nb29nbGUucGyCCyouZ29vZ2xlLnB0ghIqLmdvb2dsZWFkYXBp</span><br><span class="line"></span><span class="label">cy5jb22CDyouZ29vZ2xlYXBpcy5jboIUKi5nb29nbGVjb21tZXJjZS5jb22CESou</span></span><br><span class="line"><span class="label">Z29vZ2xldmlkZW8uY29tggwqLmdzdGF0aWMuY26CDSouZ3N0YXRpYy5jb22CCiou</span></span><br><span class="line"><span class="label">Z3Z0MS5jb22CCiouZ3Z0Mi5jb22CFCoubWV0cmljLmdzdGF0aWMuY29tggwqLnVy</span></span><br><span class="line"><span class="label">Y2hpbi5jb22CECoudXJsLmdvb2dsZS5jb22CFioueW91dHViZS1ub2Nvb2tpZS5j</span></span><br><span class="line"><span class="keyword">b22CDSoueW91dHViZS5jb22CFioueW91dHViZWVkdWNhdGlvbi5jb22CCyoueXRp</span><br><span class="line"></span><span class="keyword">bWcuY29tggthbmRyb2lkLmNvbYIEZy5jb4IGZ29vLmdsghRnb29nbGUtYW5hbHl0</span><br><span class="line"></span><span class="label">aWNzLmNvbYIKZ29vZ2xlLmNvbYISZ29vZ2xlY29tbWVyY2UuY29tggp1cmNoaW4u</span></span><br><span class="line"><span class="label">Y29tggh5b3V0dS5iZYILeW91dHViZS5jb22CFHlvdXR1YmVlZHVjYXRpb24uY29t</span></span><br><span class="line"><span class="label">MGgGCCsGAQUFBwEBBFwwWjArBggrBgEFBQcwAoYfaHR0cDovL3BraS5nb29nbGUu</span></span><br><span class="line"><span class="label">Y29tL0dJQUcyLmNydDArBggrBgEFBQcwAYYfaHR0cDovL2NsaWVudHMxLmdvb2ds</span></span><br><span class="line"><span class="label">ZS5jb20vb2NzcDAdBgNVHQ4EFgQUpypq8xCS2PlWTuyHYX7xgHb9UgwwDAYDVR0T</span></span><br><span class="line"><span class="label">AQH</span>/<span class="keyword">BAIwADAfBgNVHSMEGDAWgBRK3QYWG7z2aLV29YG2u2IaulqBLzAhBgNVHSAE</span><br><span class="line"></span><span class="label">GjAYMAwGCisGAQQB1nkCBQEwCAYGZ4EMAQICMDAGA1UdHwQpMCcwJaAjoCGGH2h0</span></span><br><span class="line"><span class="label">dHA6Ly9wa2kuZ29vZ2xlLmNvbS9HSUFHMi5jcmwwDQYJKoZIhvcNAQELBQADggEB</span></span><br><span class="line"><span class="label">AFRzPPSVNMFRDoePYeOs7awHmRpp79v7loOBMO7ctrTjpfhVjPsQmvzDlfEken2q</span></span><br><span class="line"><span class="label">HMs</span>/r76I0s7E4hk6v2ZNFiDjSnnHvjIGG1PydfEVovL/FqsX3kUaWqqCeymGcwRC</span><br><span class="line"><span class="label">ld2F6XqgKkPRf00DjbnFmDKGpRyEMQd91HoutzSMSypPqFCNSpVGuPFP32D1</span>+/Vh</span><br><span class="line"><span class="label">oukY3gGUlNGukoJ2e</span>/VNnRrU7NBvyGkW83CGPMR2iwwa0/<span class="number">7</span>aVGs1iy4aypaBo+<span class="number">0</span>q</span><br><span class="line"><span class="label">QxFmxwn1AWJYyhFbsdfrhf3ux8KEQGDEIHOSa9</span>+SjL/GYQENXGfkVIj/OG1KV0CB</span><br><span class="line"><span class="label">K8pC8t</span>/AFLMrBFjS1gbkE7U=</span><br><span class="line">-----<span class="preprocessor">END</span> CERTIFICATE-----</span><br><span class="line"> <span class="number">1</span> s:/C<span class="label">=US</span>/O<span class="label">=Google</span> Inc/<span class="preprocessor">CN</span><span class="label">=Google</span> Internet Authority G2</span><br><span class="line">   i:/C<span class="label">=US</span>/O<span class="label">=GeoTrust</span> Inc./<span class="preprocessor">CN</span><span class="label">=GeoTrust</span> <span class="preprocessor">Global</span> CA</span><br><span class="line">-----<span class="keyword">BEGIN </span>CERTIFICATE-----</span><br><span class="line"><span class="label">MIID8DCCAtigAwIBAgIDAjqDMA0GCSqGSIb3DQEBCwUAMEIxCzAJBgNVBAYTAlVT</span></span><br><span class="line"><span class="label">MRYwFAYDVQQKEw1HZW9UcnVzdCBJbmMuMRswGQYDVQQDExJHZW9UcnVzdCBHbG9i</span></span><br><span class="line"><span class="label">YWwgQ0EwHhcNMTMwNDA1MTUxNTU2WhcNMTYxMjMxMjM1OTU5WjBJMQswCQYDVQQG</span></span><br><span class="line"><span class="label">EwJVUzETMBEGA1UEChMKR29vZ2xlIEluYzElMCMGA1UEAxMcR29vZ2xlIEludGVy</span></span><br><span class="line"><span class="keyword">bmV0IEF1dGhvcml0eSBHMjCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEB</span><br><span class="line"></span><span class="label">AJwqBHdc2FCROgajguDYUEi8iT</span>/xGXAaiEZ+<span class="number">4</span>I/F8YnOIe5a/mENtzJEiaB0C1NP</span><br><span class="line"><span class="label">VaTOgmKV7utZX8bhBYASxF6UP7xbSDj0U</span>/ck5vuR6RXEz/RTDfRK/J9U3n2+oGtv</span><br><span class="line"><span class="label">h8DQUB8oMANA2ghzUWx</span>//zo8pzcGjr1LEQTrfSTe5vn8MXH7lNVg8y5Kr0LSy+rE</span><br><span class="line"><span class="label">ahqyzFPdFUuLH8gZYR</span>/Nnag+YyuENWllhMgZxUYi+FOVvuOAShDGKuy6lyARxzmZ</span><br><span class="line"><span class="label">EASg8GF6lSWMTlJ14rbtCMoU</span>/M4iarNOz0YDl5cDfsCx3nuvRTPPuj5xt970JSXC</span><br><span class="line"><span class="label">DTWJnZ37DhF5iR43xa</span>+OcmkCAwEAAaOB5zCB5DAfBgNVHSMEGDAWgBTAephojYn7</span><br><span class="line"><span class="label">qwVkDBF9qn1luMrMTjAdBgNVHQ4EFgQUSt0GFhu89mi1dvWBtrtiGrpagS8wDgYD</span></span><br><span class="line"><span class="label">VR0PAQH</span>/<span class="keyword">BAQDAgEGMC4GCCsGAQUFBwEBBCIwIDAeBggrBgEFBQcwAYYSaHR0cDov</span><br><span class="line"></span><span class="label">L2cuc3ltY2QuY29tMBIGA1UdEwEB</span>/wQIMAYBAf8CAQAwNQYDVR0fBC4wLDAqoCig</span><br><span class="line"><span class="label">JoYkaHR0cDovL2cuc3ltY2IuY29tL2NybHMvZ3RnbG9iYWwuY3JsMBcGA1UdIAQQ</span></span><br><span class="line"><span class="label">MA4wDAYKKwYBBAHWeQIFATANBgkqhkiG9w0BAQsFAAOCAQEAqvqpIM1qZ4PtXtR</span>+</span><br><span class="line"><span class="number">3</span>h3Ef+AlBgDFJPupyC1tft6dgmUsgWM0Zj7pUsIItMsv91+ZOmqcUHqFBYx90SpI</span><br><span class="line"><span class="label">hNMJbHzCzTWf84LuUt5oX</span>+QAihcglvcpjZpNy6jehsgNb1aHA30DP9z6eX0hGfnI</span><br><span class="line"><span class="label">Oi9RdozHQZJxjyXON</span>/hKTAAj78Q1EK7gI4BzfE00LshukNYQHpmEcxpw8u1VDu4X</span><br><span class="line"><span class="keyword">Bupn7jLrLN1nBz/2i8Jw3lsA5rsb0zYaImxssDVCbJAJPZPpZAkiDoUGn8JzIdPm</span><br><span class="line"></span><span class="label">X4DkjYUiOnMDsWCOrmji9D6X52ASCWg23jrW4kOVWzeBkoEfu43XrVJkFleW2V40</span></span><br><span class="line"><span class="label">fsg12A</span>==</span><br><span class="line">-----<span class="preprocessor">END</span> CERTIFICATE-----</span><br><span class="line"> <span class="number">2</span> s:/C<span class="label">=US</span>/O<span class="label">=GeoTrust</span> Inc./<span class="preprocessor">CN</span><span class="label">=GeoTrust</span> <span class="preprocessor">Global</span> CA</span><br><span class="line">   i:/C<span class="label">=US</span>/O<span class="label">=Equifax</span>/OU<span class="label">=Equifax</span> Secure Certificate Authority</span><br><span class="line">-----<span class="keyword">BEGIN </span>CERTIFICATE-----</span><br><span class="line"><span class="label">MIIDfTCCAuagAwIBAgIDErvmMA0GCSqGSIb3DQEBBQUAME4xCzAJBgNVBAYTAlVT</span></span><br><span class="line"><span class="keyword">MRAwDgYDVQQKEwdFcXVpZmF4MS0wKwYDVQQLEyRFcXVpZmF4IFNlY3VyZSBDZXJ0</span><br><span class="line"></span><span class="label">aWZpY2F0ZSBBdXRob3JpdHkwHhcNMDIwNTIxMDQwMDAwWhcNMTgwODIxMDQwMDAw</span></span><br><span class="line"><span class="label">WjBCMQswCQYDVQQGEwJVUzEWMBQGA1UEChMNR2VvVHJ1c3QgSW5jLjEbMBkGA1UE</span></span><br><span class="line"><span class="label">AxMSR2VvVHJ1c3QgR2xvYmFsIENBMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIB</span></span><br><span class="line"><span class="label">CgKCAQEA2swYYzD99BcjGlZ</span>+W988bDjkcbd4kdS8odhM+KhDtgPpTSEHCIjaWC9m</span><br><span class="line"><span class="label">OSm9BXiLnTjoBbdqfnGk5sRgprDvgOSJKA</span>+eJdbtg/OtppHHmMlCGDUUna2YRpIu</span><br><span class="line"><span class="label">T8rxh0PBFpVXLVDviS2Aelet8u5fa9IAjbkU</span>+<span class="keyword">BQVNdnARqN7csiRv8lVK83Qlz6c</span><br><span class="line"></span><span class="label">JmTM386DGXHKTubU1XupGc1V3sjs0l44U</span>+VcT4wt/lAjNvxm5suOpDkZALeVAjmR</span><br><span class="line"><span class="label">Cw7</span>+OC7RHQWa9k0+<span class="keyword">bw8HHa8sHo9gOeL6NlMTOdReJivbPagUvTLrGAMoUgRx5asz</span><br><span class="line"></span><span class="label">PeE4uwc2hGKceeoWMPRfwCvocWvk</span>+QIDAQABo4HwMIHtMB8GA1UdIwQYMBaAFEjm</span><br><span class="line"><span class="label">aPkr0rKV10fYIyAQTzOYkJ</span>/UMB0GA1UdDgQWBBTAephojYn7qwVkDBF9qn1luMrM</span><br><span class="line"><span class="label">TjAPBgNVHRMBAf8EBTADAQH</span>/MA4GA1UdDwEB/wQEAwIBBjA6BgNVHR8EMzAxMC+g</span><br><span class="line"><span class="label">LaArhilodHRwOi8vY3JsLmdlb3RydXN0LmNvbS9jcmxzL3NlY3VyZWNhLmNybDBO</span></span><br><span class="line"><span class="keyword">BgNVHSAERzBFMEMGBFUdIAAwOzA5BggrBgEFBQcCARYtaHR0cHM6Ly93d3cuZ2Vv</span><br><span class="line"></span><span class="label">dHJ1c3QuY29tL3Jlc291cmNlcy9yZXBvc2l0b3J5MA0GCSqGSIb3DQEBBQUAA4GB</span></span><br><span class="line"><span class="label">AHbhEm5OSxYShjAGsoEIz</span>/AIx8dxfmbuwu3UOx//<span class="number">8</span>PDITtZDOLC5MH0Y0FWDomrL</span><br><span class="line"><span class="label">NhGc6Ehmo21</span>/uBPUR/<span class="number">6</span>LWlxz/K7ZGzIZOKuXNBSqltLroxwUCEm2u+WR74M26x1W</span><br><span class="line"><span class="keyword">b8ravHNjkOR/ez4iyz0H7V84dJzjA1BOoa+Y7mHyhD8S</span><br><span class="line"></span>-----<span class="preprocessor">END</span> CERTIFICATE-----</span><br><span class="line">---</span><br><span class="line"><span class="label">Server</span> certificate</span><br><span class="line"><span class="keyword">subject=/C=US/ST=California/L=Mountain </span>View/O<span class="label">=Google</span> Inc/<span class="preprocessor">CN</span>=*.google.com</span><br><span class="line"><span class="label">issuer</span>=/C<span class="label">=US</span>/O<span class="label">=Google</span> Inc/<span class="preprocessor">CN</span><span class="label">=Google</span> Internet Authority G2</span><br><span class="line">---</span><br><span class="line"><span class="label">No</span> client certificate CA names sent</span><br><span class="line">---</span><br><span class="line"><span class="label">SSL</span> handshake has read <span class="number">4021</span> <span class="keyword">bytes </span><span class="keyword">and </span>written <span class="number">456</span> <span class="keyword">bytes</span><br><span class="line"></span>---</span><br><span class="line"><span class="label">New</span>, TLSv1/SSLv3, Cipher is AES128-SHA</span><br><span class="line"><span class="label">Server</span> public key is <span class="number">2048</span> <span class="keyword">bit</span><br><span class="line"></span><span class="label">Secure</span> Renegotiation IS supported</span><br><span class="line"><span class="label">Compression</span>: NONE</span><br><span class="line"><span class="label">Expansion</span>: NONE</span><br><span class="line"><span class="label">SSL</span>-Session:</span><br><span class="line">    Protocol  : TLSv1</span><br><span class="line">    Cipher    : AES128-SHA</span><br><span class="line">    Session-ID: C9BC3D21CD96713FA4EA7C21D60FF2F5DDBC6C2D2C68543652E9790C7A98DC58</span><br><span class="line">    Session-ID-ctx: </span><br><span class="line">    Master-Key: AE3A9EBD53ED49E4FDAABBCF6EA3B4096D9248127BC056CFB1F8981F2A3AB4E8779DC8195241A9A3A25DB03EDAED6077</span><br><span class="line">    Key-Arg   : None</span><br><span class="line">    Start Time: <span class="number">1445868754</span></span><br><span class="line">    Timeout   : <span class="number">300</span> (sec)</span><br><span class="line">    Verify return <span class="preprocessor">code</span>: <span class="number">0</span> (ok)</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
<p>需要声明的一点是，现在你可以用shell与服务器进行互动，你可以发出像这样的附加请求：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="request">HEAD <span class="string">/</span> HTTP/1.0</span></span><br><span class="line"><span class="attribute">Host</span>: <span class="string">www.google.com</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：记得按两次<enter> 来发送这个请求</enter></p>
</blockquote>
<p>上面的例子向谷歌发送了一个HEAD的请求，响应如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.0</span> <span class="number">302</span> Found</span><br><span class="line">Cache-Control: <span class="keyword">private</span></span><br><span class="line">Content-Type: text/html; charset=UTF-<span class="number">8</span></span><br><span class="line">Location: https:<span class="comment">//www.google.co.uk/?gfe_rd=cr&amp;ei=wzUuVtGjLLDj8wek176wCQ</span></span><br><span class="line">Content-Length: <span class="number">262</span></span><br><span class="line">Date: Mon, <span class="number">26</span> Oct <span class="number">2015</span> <span class="number">14</span>:<span class="number">16</span>:<span class="number">35</span> GMT</span><br><span class="line">Server: GFE/<span class="number">2.0</span></span><br><span class="line">Alternate-Protocol: <span class="number">443</span>:quic,p=<span class="number">1</span></span><br><span class="line">Alt-Svc: quic=<span class="string">"www.google.com:443"</span>; p=<span class="string">"1"</span>; ma=<span class="number">600</span>,quic=<span class="string">":443"</span>; p=<span class="string">"1"</span>; ma=<span class="number">600</span></span><br></pre></td></tr></table></figure>
<p>下面是一个例子，但是这次我们查询的服务使用的是自签名证书，所以我们被要求提供CA以及我们自己的客户端证书做身份验证（P.S. 这个例子不能工作）：</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">openssl s_client \</span><br><span class="line">  -<span class="ruby">connect my-fake-service.<span class="symbol">com:</span><span class="number">443</span> \</span><br><span class="line"></span>  -<span class="ruby"><span class="constant">CAfile</span> /<span class="constant">Users</span>/<span class="constant">Integralist</span>/.pki/custom-ca.pem \</span><br><span class="line"></span>  -<span class="ruby">cert /<span class="constant">Users</span>/<span class="constant">Integralist</span>/.pki/<span class="constant">Certificate</span>.pem \</span><br><span class="line"></span>  -<span class="ruby">key /<span class="constant">Users</span>/<span class="constant">Integralist</span>/.pki/<span class="constant">Certificate</span>.key \</span><br><span class="line"></span>  -<span class="ruby">showcerts</span></span><br></pre></td></tr></table></figure>
<p>最后一个例子，我们将尝试并验证一个特定的密码是否被禁用（在这个例子里，是不安全的RC4密码）：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">openssl</span> <span class="tag">s_client</span> <span class="tag">-connect</span> <span class="tag">blog</span><span class="class">.mozilla</span><span class="class">.org</span><span class="pseudo">:443</span> <span class="tag">-showcerts</span> <span class="tag">-cipher</span> <span class="tag">RC4-SHA</span></span><br></pre></td></tr></table></figure>
<p>Mozilla在最近的一篇post上声明他们讲不继续支持这种密码，所以上面的命令将会返回如下结果，告诉你SSL握手失败了：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">57533</span>:<span class="string">error:</span><span class="number">14077410</span>:SSL <span class="string">routines:</span><span class="string">SSL23_GET_SERVER_HELLO:</span>sslv3 alert handshake <span class="string">failure:</span><span class="regexp">/BuildRoot/</span>Library<span class="regexp">/Caches/</span>com.apple.xbs<span class="regexp">/Sources/</span>OpenSSL098<span class="regexp">/OpenSSL098-59/</span>src<span class="regexp">/ssl/</span>s23_clnt.<span class="string">c:</span><span class="number">593</span>:</span><br></pre></td></tr></table></figure>
<h2 id="u8BC1_u4E66_u7B7E_u540D"><a href="#u8BC1_u4E66_u7B7E_u540D" class="headerlink" title="证书签名"></a>证书签名</h2><p>客户端和服务器彼此验证对方身份的一种方法是通过SSL握手时互传的MAC。客户端首先会验证服务器提供的证书（在SSL握手的初始阶段），证书不仅需要由我们信任的CA签名，还需要在传输的过程中没有被改动过。</p>
<p>客户端可以通过检查证书上的签名来完成这项工作。早些时候我们讨论过CA怎么生成证书：CA将会给证书“签名”。签名包含两个步骤，首先将散列函数应用到证书的内容上生成一个哈希值，然后这个哈希值再用CA的私钥加密。</p>
<p>通过这项技术，客户端可以辨别证书是否被替换过。浏览器通过使用和CA相同的散列函数（使用的散列函数也是证书的一部分内容）将证书转换成一个哈希值。然后客户端可以使用CA的公钥对签名进行解密（也会得到一个哈希值）。浏览器可以对比两个哈希值（一个是从证书内容中产生的，一个是从签名中抽出来的），如果两个值相同，则没有被改动过，反之，则证书被改动过。</p>
<p><a href="https://en.wikipedia.org/wiki/Public_key_certificate" target="_blank" rel="external">Public key certificate</a></p>
<h2 id="PKI_u7ED3_u8BED"><a href="#PKI_u7ED3_u8BED" class="headerlink" title="PKI结语"></a>PKI结语</h2><p>好了，现在你知道PKI（还有SSL/TLS）是如何运作的了，让我们继续吧！</p>
<h1 id="OpenSSL_vs_OpenSSH"><a href="#OpenSSL_vs_OpenSSH" class="headerlink" title="OpenSSL vs OpenSSH"></a>OpenSSL vs OpenSSH</h1><p>为了在互联网上更加安全地传输数据，你可能会想要生成自己的密钥和证书。那么你需要安装OpenSSL命令行工具。OpenSSL实现了SSL/TLS协议。</p>
<blockquote>
<p> 注：OpenSSL命令是对OpenSSL库的一个包装</p>
</blockquote>
<p>你可能不知道，OpenSSL实际上提供了很大的一套密码工具。这篇文章后面会演示使用这些工具的一小部分来创建自己的密钥和加密一些数据。现在我们更注重的是OpenSSL和OpenSSH之间的差异。</p>
<p>OpenSSL的设计目的是提供一个保证网络通信安全的方法。另一方面，OpenSSH提供了保护并加密通道的功能，通常用来建立从你的机器到外部服务器之间的Secure Shell（SSH）连接。</p>
<p>OpenSSH使用了OpenSSL来完成加密操作（例如，密钥生成），和OpenSSL相比，它实现了一个不同的传输协议。所以，只要你使用相同的算法生成密钥，那么在安全角度上来看，OpenSSH和OpenSSL并没有太大差异。（你可能会说，明显对于OpenSSH的攻击量更多，所以它可能给攻击者留了更多的漏洞，不是那么安全）</p>
<blockquote>
<p> 注：通常人们提到OpenSSH实际上是指根据OpenSSH协议标准设计的命令行工具。（OpenSSH是一个“协议”，并不是大家使用的命令行工具本身）</p>
</blockquote>
<h2 id="OpenSSH_u7684_u4F7F_u7528"><a href="#OpenSSH_u7684_u4F7F_u7528" class="headerlink" title="OpenSSH的使用"></a>OpenSSH的使用</h2><p>OpenSSH提供了很多不同的可用工具，以下是建立在OpenSSH协议上的工具列表：</p>
<ul>
<li><code>ssh-keygen</code></li>
<li><code>ssh-agent</code></li>
<li><code>ssh-add</code></li>
<li><code>ssh-keysign</code></li>
<li><code>ssh-keyscan</code></li>
<li><code>sftp-server</code></li>
<li><code>sshd</code></li>
</ul>
<h1 id="GPG_u662F_u4EC0_u4E48_uFF1F"><a href="#GPG_u662F_u4EC0_u4E48_uFF1F" class="headerlink" title="GPG是什么？"></a>GPG是什么？</h1><p>GPG是一个提供了加密和签名功能的工具。它的全名是“GNU Privacy Guard”。</p>
<p>GPG支持对称加密和非对称加密，另外还提供一个可选的数字签名功能，来保证加密数据的完整性（未被中间人修改过）。</p>
<p>后面，我们将会演示如何使用GPG。</p>
<h2 id="GPG_vs_PGP"><a href="#GPG_vs_PGP" class="headerlink" title="GPG vs PGP"></a>GPG vs PGP</h2><p>你可能还听说过PGP，PGP是一个协议标准（命名为”Open PGP”），GPG实现了这个协议标准。</p>
<h1 id="u521B_u5EFA_u4F60_u81EA_u5DF1_u7684_u5BC6_u94A5"><a href="#u521B_u5EFA_u4F60_u81EA_u5DF1_u7684_u5BC6_u94A5" class="headerlink" title="创建你自己的密钥"></a>创建你自己的密钥</h1><p>好了，目前为止，我们只讨论了一些理论知识。现在要实践了，我们会用之前提到的三种工具（OpenSSH，OpenSSL和GPG）来生成自己的密钥。</p>
<p>我不会详细地解释每个命令中使用的标志/设置，你可以自己<code>man</code>来了解这些细节。</p>
<p>此外，生成密钥只是一部分。对于OpenSSL和GPG来说，直到加密数据的时候，这些密钥才变得有用。</p>
<p>让我们开始吧！</p>
<h2 id="OpenSSH"><a href="#OpenSSH" class="headerlink" title="OpenSSH"></a>OpenSSH</h2><p>在下面的例子中，我们会使用RSA算法和4096位的密钥长度生成一组新的密钥（公钥和私钥）。这是相当安全的设置（在今天这个数字时代，任何低于2048位的密钥会被轻易攻破）：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -<span class="tag">b</span> <span class="number">4096</span> -C <span class="string">"your.email@service.com"</span></span><br></pre></td></tr></table></figure>
<p>运行这个命令，你会被要求为密钥提供一个名字，还有一个密码（可选）。之后你会发现当前目录下生成了两个文件（假设我们提供的名字是<code>foo_rsa</code>）：</p>
<ul>
<li><code>foo_rsa</code>: 私钥</li>
<li><code>foo_rsa.pub</code>: 公钥</li>
</ul>
<blockquote>
<p> 注：你可以通过<code>SSH-keygen -p</code>命令更改与私钥相关联的密码。</p>
</blockquote>
<p>现在我们有了这两个密钥，可以把公钥放到外部的服务（如github）或者远程服务器上。这样我们就可以和远程的服务或者服务器进行安全的通信了。</p>
<p>如果你想要连接到远端服务器，你可以让你的运维帮你把公钥加到<code>~/.ssh/</code>文件夹下，或者你也可以自己来（<code>cat foo_rsa.pub | ssh user@123.45.56.78 &quot;mkdir -p ~/.ssh &amp;&amp; cat &gt; &gt;  ~/.ssh/authorized_keys&quot;</code>）。一旦加入了你的公钥，你就可以在不需要密码的情况下安全访问服务器，因为你的私钥将会作为访问的凭证。</p>
<blockquote>
<p> 注：默认是SSH密钥是放在<code>~/.ssh/</code>文件夹下的</p>
</blockquote>
<p>你还可以进一步设置，限制只能通过SSH密钥登录服务器。为了达成这个目的，你需要登录到服务器，并修改<code>/etc/ssh/sshd_config</code>文件，找到<code>PermitRootLogin</code>那一行，并改成<code>PermitRootLogin without-password</code>。重新启动ssh，修改就会立即生效。</p>
<h2 id="SSH_u4EE3_u7406"><a href="#SSH_u4EE3_u7406" class="headerlink" title="SSH代理"></a>SSH代理</h2><p>大多数操作系统都有可用的<code>ssh-agent</code>。如果你已经安装了<code>ssh-keygen</code>，那么很有可能你也已经安装了<code>ssh-agent</code>和其他OpenSSH工具。<br>该代理是用来存储私钥的，它会让SSH的使用更加容易：允许你一次性地设置私钥密码（便利性的代价是安全性能的下降）。</p>
<p>当我设置我的github SSH密钥时，我会运行下面的命令：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> ~/.ssh</span><br><span class="line">ssh-keygen -<span class="keyword">t</span> rsa -<span class="keyword">b</span> <span class="number">4096</span> -C <span class="string">"my.email@domain.com"</span> #  saved <span class="keyword">as</span> github_rsa</span><br><span class="line"><span class="built_in">eval</span> <span class="string">"$(ssh-agent -s)"</span></span><br><span class="line">ssh-<span class="built_in">add</span> -K ~/.ssh/github_rsa</span><br><span class="line">pbcopy &lt; ~/.ssh/github_rsa.pub</span><br><span class="line">ssh -T git@github.<span class="keyword">com</span></span><br></pre></td></tr></table></figure>
<p>这里一共做了以下几件事：</p>
<ul>
<li>cd到存放SSH密钥的目录</li>
<li>生成我自己的SSH密钥（存成<code>github_rsa</code>）</li>
<li>启动SSH代理</li>
<li>使用<code>ssh-add</code>命令将我的私钥添加到代理中</li>
<li>拷贝我的公钥（然后手动把它粘贴到GitHub GUI中）</li>
<li>连接到github，验证设置</li>
</ul>
<p><a href="https://help.github.com/articles/generating-ssh-keys/# platform-mac" target="_blank" rel="external">Generating SSH keys - User Documentation</a></p>
<h2 id="OpenSSL"><a href="#OpenSSL" class="headerlink" title="OpenSSL"></a>OpenSSL</h2><p>和上一节一样，我们将会使用RSA和4096位的密钥长度生成一组新密钥（公钥和私钥）。区别在于，你需要先生成私钥，然后从中抽取公钥：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out private_key<span class="class">.pem</span> <span class="number">4096</span></span><br><span class="line">openssl rsa -pubout -<span class="keyword">in</span> private_key<span class="class">.pem</span> -out public_key.pem</span><br></pre></td></tr></table></figure>
<p>你还可以通过添加<code>-text</code>标志，打印出包含在pem文件里的额外信息：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl rsa -<span class="type">text</span> -<span class="keyword">in</span> private_key.pem</span><br></pre></td></tr></table></figure>
<h2 id="GPG"><a href="#GPG" class="headerlink" title="GPG"></a>GPG</h2><p>用GPG生成一对密钥要稍微麻烦些，因为你需要根据提示输入一些内容，首先输入命令：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg <span class="comment">--gen-key</span></span><br></pre></td></tr></table></figure>
<p>将会显示如下信息：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Please <span class="operator"><span class="keyword">select</span> what kind <span class="keyword">of</span> <span class="keyword">key</span> you want:</span><br><span class="line">(<span class="number">1</span>) RSA <span class="keyword">and</span> RSA (<span class="keyword">default</span>)</span><br><span class="line">(<span class="number">2</span>) DSA <span class="keyword">and</span> Elgamal</span><br><span class="line">(<span class="number">3</span>) DSA (<span class="keyword">sign</span> <span class="keyword">only</span>)</span><br><span class="line">(<span class="number">4</span>) RSA (<span class="keyword">sign</span> <span class="keyword">only</span>)</span><br><span class="line">Your selection?</span></span><br></pre></td></tr></table></figure>
<p>然后会问你需要的密钥长度（这里我和上面一样，输入了4096）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RSA keys may be between <span class="number">1024</span> and <span class="number">4096</span> bits <span class="keyword">long</span>.</span><br><span class="line">What keysize <span class="keyword">do</span> you want? (<span class="number">2048</span>)</span><br></pre></td></tr></table></figure>
<p>接着，会要你提供一个过期时间（我选择了一年）：</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Requested keysize <span class="keyword">is</span> <span class="number">4096</span> bits       </span><br><span class="line">Please specify how <span class="built_in">long</span> the <span class="keyword">key</span> should be valid.</span><br><span class="line">         <span class="number">0</span> = <span class="keyword">key</span> does <span class="keyword">not</span> expire</span><br><span class="line">      &lt;n&gt;   = <span class="keyword">key</span> expires <span class="keyword">in</span> n days</span><br><span class="line">      &lt;n&gt; w = <span class="keyword">key</span> expires <span class="keyword">in</span> n weeks</span><br><span class="line">      &lt;n&gt; m = <span class="keyword">key</span> expires <span class="keyword">in</span> n months</span><br><span class="line">      &lt;n&gt; y = <span class="keyword">key</span> expires <span class="keyword">in</span> n years</span><br><span class="line"><span class="keyword">Key</span> <span class="keyword">is</span> valid <span class="keyword">for</span>? (<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>最后，你需要输入一些个人信息。我不会在这里展示，你可以自己试一试。另外值得注意的是，GPG会使用系统的熵来帮助它生成随机数，所以你会被要求移动一下光标，来协助产生随机数。</p>
<blockquote>
<p> 注：你也可以通过一个输入文件来提供上述所需要的内容（当你想要产生很多成对密钥时，这个方法很有用），如果你想了解更多的细节，可以参考<a href="https://www.gnupg.org/documentation/manuals/gnupg/Unattended-GPG-key-generation.html" target="_blank" rel="external">这里</a>。</p>
</blockquote>
<p>当你生成完密钥之后，你可能会问它们在哪儿呢？它们并不在当前的目录下，你需要使用下面的命令来查看生成的密钥：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg --<span class="keyword">list</span>-<span class="built_in">keys</span></span><br></pre></td></tr></table></figure>
<p>我这里的输出是：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="header">/Users/M/.gnupg/pubring.gpg</span><br><span class="line">---------------------------</span></span><br><span class="line">pub   4096R/056C9716 2015-08-14 [expires: 2016-08-13]</span><br><span class="line">uid                  Mark McDonnell (Hi) &lt;my.email@domain.com&gt; </span><br><span class="line">sub   4096R/A1F3D5B6 2015-08-14 [expires: 2016-08-13]</span><br></pre></td></tr></table></figure>
<blockquote>
<p> 注：对应的，这里有一个命令用于查看私钥：<code>gpg --list-secret-keys</code>。</p>
</blockquote>
<p>你可以看到有个<code>pubring.gpg</code>文件，里面包含了我创建密钥时输入的信息，有趣的是这个文件本身是受保护的，如果我尝试<code>cat ~/.gnupg/pubring.gpg</code>，会输出的是加密后的密文。</p>
<p>如果你想要查看自己的公钥，需要使用下面的命令（请注意我指定了名称”Mark McDonnell”，和我们刚才用<code>--list-keys</code>看到的输出一样）：</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg --export -a <span class="string">"Mark McDonnell"</span> | xargs -<span class="keyword">I</span> <span class="list">&#123;&#125;</span> echo <span class="list">&#123;&#125;</span> &gt;  gpg_public.key</span><br></pre></td></tr></table></figure>
<p>如果你想要得到私钥，你需要使用一个不同的标志：</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg --export-secret-key -a <span class="string">"Mark McDonnell"</span> | xargs -<span class="keyword">I</span> <span class="list">&#123;&#125;</span> echo <span class="list">&#123;&#125;</span> &gt;  gpg_private.key</span><br></pre></td></tr></table></figure>
<h1 id="u5982_u4F55_u4F7F_u7528GPG_u548COpenSSL_u6765_u52A0_u5BC6_u6570_u636E"><a href="#u5982_u4F55_u4F7F_u7528GPG_u548COpenSSL_u6765_u52A0_u5BC6_u6570_u636E" class="headerlink" title="如何使用GPG和OpenSSL来加密数据"></a>如何使用GPG和OpenSSL来加密数据</h1><p>除了PKI和SSL/TLS，最常见的一个任务就是加密包含敏感信息的特定文件。不同的工具加密数据的接口也不同，让我们来看看GPG和OpenSSL的：</p>
<h2 id="GPG_u52A0_u5BC6"><a href="#GPG_u52A0_u5BC6" class="headerlink" title="GPG加密"></a>GPG加密</h2><p>GPG提供了两种加密方式：非对称和对称的……</p>
<h2 id="u975E_u5BF9_u79F0_u52A0_u5BC6"><a href="#u975E_u5BF9_u79F0_u52A0_u5BC6" class="headerlink" title="非对称加密"></a>非对称加密</h2><p>使用GPG，你需要接受者的公钥来加密文件。所以当你拿到对方的公钥之后，你需要将其导入到GPG中：</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg --<span class="keyword">import</span> <span class="keyword">public</span>.<span class="variable">key</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p> 注：之后如果要删除这些公钥，运行<code>gpg --delete-key &quot;user name&quot;</code></p>
</blockquote>
<p>之后你可以用这个公钥加密文件：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg -<span class="keyword">e</span> -<span class="keyword">u</span> <span class="string">"Sender User Name"</span> -r <span class="string">"Receiver User Name"</span> somefile</span><br></pre></td></tr></table></figure>
<p>要解密一个用你的公钥和GPG加密过的文件，可以使用下面的命令（会自动定位你的私钥，如果你有多个私钥，会向你询问密码）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg <span class="operator">-d</span> some_encrypted_file.gpg</span><br></pre></td></tr></table></figure>
<p>上面的命令会直接把解密的内容输出到stdout，所以如果你需要将其重定向到一个文件里，可以像下面这样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg -o output_file <span class="operator">-d</span> some_encrypted_file.gpg</span><br></pre></td></tr></table></figure>
<h2 id="u5BF9_u79F0_u52A0_u5BC6"><a href="#u5BF9_u79F0_u52A0_u5BC6" class="headerlink" title="对称加密"></a>对称加密</h2><p>如果你不想用一对密钥来加密文件，你可以使用标准的对称加密：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg <span class="comment">--symmetric secrets.txt</span></span><br></pre></td></tr></table></figure>
<p>gpg会向你请求一个密码，之后会将加密后的文件导出到当前文件夹下。</p>
<p>你还可以通过<code>--sign</code>标志添加一个MAC（我们在讨论PKI的时候说过，就是一个数字签名）：</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">gpg</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">default</span><span class="literal">-</span><span class="comment">key</span> <span class="comment">email@domain</span><span class="string">.</span><span class="comment">com</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">symmetric</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">sign</span> <span class="comment">secrets</span><span class="string">.</span><span class="comment">txt</span></span><br></pre></td></tr></table></figure>
<p>当你解密gpg文件，并输入了相应密码时，你将会看到以下输出：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gpg: Signature made Mon <span class="number">17</span> Aug <span class="number">17</span>:<span class="number">37</span>:<span class="number">58</span> <span class="number">2015</span> BST <span class="keyword">using</span> RSA key ID BAE1D7F0</span><br><span class="line">gpg: Good signature from <span class="string">"Mark McDonnell (Integralist) &lt;email@domain.com&gt; "</span></span><br><span class="line">gpg: WARNING: message was not integrity <span class="keyword">protected</span></span><br></pre></td></tr></table></figure>
<h2 id="OpenSSL_u52A0_u5BC6"><a href="#OpenSSL_u52A0_u5BC6" class="headerlink" title="OpenSSL加密"></a>OpenSSL加密</h2><p>使用OpenSSL加密文件的最简单方法如下（文件的密码是foobar，在命令的最末端，我们还使用了salt以提高安全性）：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -<span class="keyword">n</span> 'someTextIWantToEncrypt' | openssl <span class="keyword">enc</span> -<span class="keyword">e</span> -salt -<span class="keyword">out</span> <span class="keyword">test</span>.txt -aes-256-cbc -pass pass:foobar</span><br></pre></td></tr></table></figure>
<p>要解密这个文件，我们可以使用<code>-d</code>标志（<code>-e</code>标志是加密）：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl <span class="keyword">enc</span> -<span class="keyword">d</span> -salt -<span class="keyword">in</span> <span class="keyword">test</span>.txt -<span class="keyword">out</span> decrypted.txt -aes-256-cbc -pass pass:foobar</span><br></pre></td></tr></table></figure>
<p>如果你不怕麻烦想要通信可以更加安全，可以使用一对密钥。下面的例子中，假设我们是”Alice”，收件人是”Bob”：</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#  Bob需要把他的RSA密钥用PEM证书的格式发送给我们</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#  所以Bob首先要做的事情是生成一个包含他私钥的PEM</span></span><br><span class="line">openssl rsa -in id_rsa -outform pem &gt;  id_rsa.pem</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#  然后生成一个含有Bob公钥的PEM</span></span><br><span class="line">openssl rsa -in id_rsa -pubout -outform pem &gt;  id_rsa.pub.pem</span><br></pre></td></tr></table></figure>
<p>这时，Alice和Bob需要解决的问题是如何安全地共享彼此的公钥。我会建议直接当面递交，以避免网络嗅探的问题（用浏览器和server交互的情况下，我们有PKI来帮助我们“认证” —— 但是很遗憾我们并没有这样的机制）。</p>
<p>一旦Alice得到了Bob的公钥，她会按照下面的步骤操作：</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#  Alice生成一个<span class="number">256</span>位(<span class="number">32</span> <span class="built_in">byte</span>)的<span class="built_in">random</span> <span class="variable">key</span></span><br><span class="line">openssl rand -base64 <span class="number">32</span> &gt;  <span class="variable">key</span>.bin</span><br><span class="line"></span><br><span class="line">#  Alice用Bob的公钥来加密这个<span class="built_in">random</span> <span class="variable">key</span></span><br><span class="line">openssl rsautl -encrypt -inkey id_rsa.pub.pem -pubin -in <span class="variable">key</span>.bin -out <span class="variable">key</span>.bin.enc</span><br><span class="line"></span><br><span class="line"># Alice用Bob的公钥加密文件</span><br><span class="line">openssl enc -aes-<span class="number">256</span>-cbc -salt -in SECRET_FILE -out SECRET_FILE.enc -pass file:./<span class="variable">key</span>.bin</span><br></pre></td></tr></table></figure>
<p>Alice现在可以发送加密后的文件（例如：<code>SECRET_FILE.enc</code>）给Bob。一旦Bob拿到加密文件，他可以follow下面几个步骤：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#  Bob使用自己的私钥解密得到random key</span><br><span class="line">openssl rsautl -decrypt -inkey id_rsa.pem -<span class="keyword">in</span> key.bin.<span class="keyword">enc</span> -<span class="keyword">out</span> key.bin</span><br><span class="line"></span><br><span class="line">#  Bob用自己的私钥和来解密文件</span><br><span class="line">openssl <span class="keyword">enc</span> -<span class="keyword">d</span> -aes-256-cbc -<span class="keyword">in</span> SECRET_FILE.<span class="keyword">enc</span> -<span class="keyword">out</span> SECRET_FILE -pass <span class="keyword">file</span>:./key.bin</span><br></pre></td></tr></table></figure>
<h2 id="u6211_u8BE5_u7528_u54EA_u4E00_u4E2A"><a href="#u6211_u8BE5_u7528_u54EA_u4E00_u4E2A" class="headerlink" title="我该用哪一个"></a>我该用哪一个</h2><p>OpenSSL在今天这个数字时代被认为是不安全的。<code>enc</code>命令的实现是有bug的，所以在安全社区似乎都推荐丢掉OpenSSL，使用GPG（至少在想要分享一个私密文件这种简单的情景下，更推荐GPG）。</p>
<h1 id="u521B_u5EFA_uFF0C_u7B7E_u540D_uFF0C_u53D1_u5E03_u548C_u540A_u9500_u8BC1_u4E66"><a href="#u521B_u5EFA_uFF0C_u7B7E_u540D_uFF0C_u53D1_u5E03_u548C_u540A_u9500_u8BC1_u4E66" class="headerlink" title="创建，签名，发布和吊销证书"></a>创建，签名，发布和吊销证书</h1><p>好了，下面我准备创建一个新的根CA，然后我们就可以从自己的个人CA来签发私人证书了。如果有个机构它不想付钱给CA来获得证书，那么就可以用这个方法。（有些服务仅允许通过客户端证书的访问，只要使用者信任发放证书的单位，就没有问题）</p>
<p>我不打算详细地说，因为Ivan Ristić（”Bulletproof SSL and TSL”的作者）已经做了这些工作，你可以在他的免费电子书”<a href="https://www.feistyduck.com/books/openssl-cookbook/" target="_blank" rel="external">OpenSSL Cookbook</a>“中找到相应信息。</p>
<p>如果你想快速地看一下主要流程….</p>
<p>你可以生成一个CSR（证书签名请求，你需要发送给CA，等待CA批准）：</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -sha256 -<span class="keyword">new</span> -<span class="variable">key</span> my-<span class="keyword">private</span>-<span class="variable">key</span>.pem -out csr.pem</span><br></pre></td></tr></table></figure>
<p>然后你可以对这个证书做自签名：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -days <span class="number">365</span> -<span class="keyword">in</span> csr<span class="class">.pem</span> -signkey my-private-key<span class="class">.pem</span> -out my-certificate.pem</span><br></pre></td></tr></table></figure>
<blockquote>
<p> 注：用一行命令同时生成一对密钥+证书<br> <code>openssl req -nodes -new -x509 -keyout server.key -out server.cert</code></p>
</blockquote>
<h2 id="u66F4_u65B0"><a href="#u66F4_u65B0" class="headerlink" title="更新"></a>更新</h2><p>我把证书有关的操作写在<a href="http://www.integralist.co.uk/posts/clientcertauth.html" target="_blank" rel="external">这里</a>了，文章里讨论了如何用Docker来处理客户端证书验证。</p>
<h1 id="u7ED3_u8BBA"><a href="#u7ED3_u8BBA" class="headerlink" title="结论"></a>结论</h1><p>希望坚持看完这篇文章的人，可以得到一些有用的知识或者启发。我写这篇文章的主要目的是帮助自己巩固已学的知识，将来需要用到的时候也能有个参考。最后，我真的很享受钻研这个领域的过程，例如，PKI和SSL握手，因为这是困扰我很长时间的一些知识点。</p>
<p>如果有任何的明显的错误（我敢肯定，会有一些疏漏），那么请告诉我，我一定会及时更正的。谢谢！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://unicorn-42.com/2015/12/08/[译]安全基础：GPG, OpenSSH和OpenSSL/" data-id="cihxitpv50005lcq5mesv9amw" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-jQuery Source Code Study 2 - Core Module" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/11/30/jQuery Source Code Study 2 - Core Module/" class="article-date">
  <time datetime="2014-11-30T15:38:49.000Z" itemprop="datePublished">2014-11-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/30/jQuery Source Code Study 2 - Core Module/">jQuery Source Code Study 2 - Core Module</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I went through <code>intro.js</code>, <code>outro.js</code> and <code>core/init.js</code> in the <a href="http://by-unicorn.com/2014/11/25/jQuery-Source-Code-Study%201%20Basic-Structure/">previous post</a>, since they are the very entry of jQuery. From now on, I will continue my work following the order defined in <code>jQuery.js</code>.<br>So, my second stop is <code>core.js</code> and <code>core/access.js</code>.<br>
        
          <p class="article-more-link">
            <a href="/2014/11/30/jQuery Source Code Study 2 - Core Module/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://unicorn-42.com/2014/11/30/jQuery Source Code Study 2 - Core Module/" data-id="cihxitpup0000lcq5r4xt95bb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jQuery/">jQuery</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-jQuery Source Code Study 1 - Basic Structure" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/11/25/jQuery Source Code Study 1 - Basic Structure/" class="article-date">
  <time datetime="2014-11-25T15:01:55.000Z" itemprop="datePublished">2014-11-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/25/jQuery Source Code Study 1 - Basic Structure/">jQuery Source Code Study 1 - Basic Structure</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Recently I took an online course called “<a href="http://www.imooc.com/view/172?utm_source=jobboleweibo">jQuery Source Code Analysis</a>“ which gave a brief introduction for jQuery source code. Since the length of course is limited, the instructor cannot explain every knowledge point in detail.<br>Here I would like to go through the source code and explain the knowledge points in a more intensive manner.<br>You can clone the <a href="https://github.com/jquery/jquery">jQuery project</a> from Github, the source codes in <code>src</code> directory are separated in different modules, and it’s easier to understand module one by one than read the whole source code directly. </p>
<p>Since this is the first post, I will introduce the entry of jQuery, including <code>intro.js</code>, <code>outro.js</code> and <code>core/init.js</code>.</p>
<p>p.s.  The chapters with <code>*</code> are further readings.<br>
        
          <p class="article-more-link">
            <a href="/2014/11/25/jQuery Source Code Study 1 - Basic Structure/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://unicorn-42.com/2014/11/25/jQuery Source Code Study 1 - Basic Structure/" data-id="cihxitpv50003lcq5je8fzte7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jQuery/">jQuery</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/jQuery/">jQuery</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/jQuery/" style="font-size: 10px;">jQuery</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/12/08/[译]安全基础：GPG, OpenSSH和OpenSSL/">GPG, OpenSSH &amp; OpenSSL</a>
          </li>
        
          <li>
            <a href="/2014/11/30/jQuery Source Code Study 2 - Core Module/">jQuery Source Code Study 2 - Core Module</a>
          </li>
        
          <li>
            <a href="/2014/11/25/jQuery Source Code Study 1 - Basic Structure/">jQuery Source Code Study 1 - Basic Structure</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 byunicorn<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>